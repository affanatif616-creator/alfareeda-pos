<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alfareeda Opticals | Business Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: #1a2a47; --accent: #f89e1b; --success: #28a745; --danger: #dc3545; --light: #f8f9fa; }
        body { font-family: 'Inter', sans-serif; background: #eef2f7; margin: 0; color: #333; }
        
        /* Layout */
        .navbar { background: var(--primary); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1300px; margin: 20px auto; padding: 0 20px; }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border-left: 5px solid var(--accent); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-card h4 { margin: 0; font-size: 13px; color: #777; text-transform: uppercase; }
        .stat-card p { margin: 10px 0 0; font-size: 24px; font-weight: bold; color: var(--primary); }

        /* Main Workspace */
        .main-grid { display: grid; grid-template-columns: 400px 1fr; gap: 25px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        /* UI Components */
        h3 { margin-top: 0; font-size: 18px; border-bottom: 2px solid var(--light); padding-bottom: 10px; margin-bottom: 20px; color: var(--primary); }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; margin-top: 20px; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: var(--light); padding: 15px; text-align: left; font-size: 12px; color: #666; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .wa-btn { background: #25D366; color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-size: 20px; font-weight: bold;">ALFAREEDA <span style="color:var(--accent)">POS</span></div>
    <div id="clock">Loading...</div>
</div>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card"><h4>Sales Today</h4><p id="statSales">OMR 0.000</p></div>
        <div class="stat-card" style="border-left-color: var(--danger)"><h4>Expenses Today</h4><p id="statExp">OMR 0.000</p></div>
        <div class="stat-card" style="border-left-color: var(--success)"><h4>Net Profit</h4><p id="statProfit">OMR 0.000</p></div>
    </div>

    <div class="main-grid">
        <div class="side-panel">
            <div class="card">
                <h3>New Order Entry</h3>
                <div class="form-group"><label>CUSTOMER NAME</label><input type="text" id="custName"></div>
                <div class="form-group"><label>PHONE</label><input type="text" id="custPhone"></div>
                <div style="display:flex; gap:10px;">
                    <div class="form-group"><label>RE</label><input type="text" id="re"></div>
                    <div class="form-group"><label>LE</label><input type="text" id="le"></div>
                </div>
                <div class="form-group"><label>ITEMS</label><textarea id="items" rows="2"></textarea></div>
                <div style="display:flex; gap:10px;">
                    <div class="form-group"><label>TOTAL</label><input type="number" id="total" oninput="calcBal()"></div>
                    <div class="form-group"><label>ADVANCE</label><input type="number" id="advance" oninput="calcBal()"></div>
                </div>
                <div class="form-group"><label>BALANCE DUE</label><input type="number" id="balance" readonly style="background:#eee"></div>
                <button class="btn btn-primary" onclick="saveSale()">CREATE INVOICE</button>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>Record Expense</h3>
                <div class="form-group"><label>CATEGORY</label>
                    <select id="expCat"><option>Stock</option><option>Rent</option><option>Salary</option><option>Bills</option></select>
                </div>
                <div class="form-group"><label>AMOUNT (OMR)</label><input type="number" id="expAmount"></div>
                <button class="btn btn-danger" onclick="saveExpense()">SAVE EXPENSE</button>
            </div>
        </div>

        <div class="card">
            <h3>Customer Management</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="searchPhone" placeholder="Enter phone number to search history...">
                <button class="btn btn-primary" style="width:150px;" onclick="searchRecords()">Search</button>
            </div>
            <div id="results">
                <p style="text-align:center; color:#999; margin-top:50px;">Search for a customer to view prescriptions or update status.</p>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. CONFIGURATION
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyFEP0YEYgMbQEOOO24goKBsYYWVBtHPMbZ7fP2WOJlnwsgn-xt0I64TGK9GAtjfgUjEw/exec';
    let salesToday = 0, expToday = 0;

    // 2. UTILITIES
    function calcBal() {
        const t = parseFloat(document.getElementById('total').value) || 0;
        const a = parseFloat(document.getElementById('advance').value) || 0;
        document.getElementById('balance').value = (t - a).toFixed(3);
    }

    function updateDash() {
        document.getElementById('statSales').innerText = "OMR " + salesToday.toFixed(3);
        document.getElementById('statExp').innerText = "OMR " + expToday.toFixed(3);
        document.getElementById('statProfit').innerText = "OMR " + (salesToday - expToday).toFixed(3);
    }

    // 3. CORE FUNCTIONS
    function saveSale() {
        const name = document.getElementById('custName').value;
        const total = document.getElementById('total').value;
        if(!name || !total) return Swal.fire("Error", "Name and Total are required", "error");

        const params = `action=saveSale&name=${encodeURIComponent(name)}&phone=${document.getElementById('custPhone').value}&re=${document.getElementById('re').value}&le=${document.getElementById('le').value}&items=${encodeURIComponent(document.getElementById('items').value)}&total=${total}&advance=${document.getElementById('advance').value}&balance=${document.getElementById('balance').value}&payment=Cash`;

        fetch(`${scriptURL}?${params}`).then(res => res.json()).then(data => {
            Swal.fire("Success", "Invoice: " + data.inv, "success");
            salesToday += parseFloat(total); updateDash();
        });
    }

    function saveExpense() {
        const amt = document.getElementById('expAmount').value;
        if(!amt) return;
        fetch(`${scriptURL}?action=saveExpense&category=${document.getElementById('expCat').value}&amount=${amt}`)
            .then(() => { Swal.fire("Recorded", "Expense saved", "info"); expToday += parseFloat(amt); updateDash(); });
    }

    function searchRecords() {
        const phone = document.getElementById('searchPhone').value;
        document.getElementById('results').innerHTML = "Searching...";
        fetch(`${scriptURL}?phone=${phone}`).then(res => res.json()).then(data => {
            if(data.length === 0) return document.getElementById('results').innerHTML = "No record found.";
            let html = `<table><tr><th>Inv #</th><th>Name</th><th>Balance</th><th>Status</th><th>Actions</th></tr>`;
            data.forEach(row => {
                let wa = `https://wa.me/${row.contact}?text=Hi ${row.name}, Order ${row.invoice} is ${row.status}. Balance: ${row.balance}`;
                html += `<tr>
                    <td><b>${row.invoice}</b></td>
                    <td>${row.name}</td>
                    <td style="color:red">${row.balance}</td>
                    <td>
                        <select onchange="updateStatus(${row.row}, this.value)">
                            <option value="Processing" ${row.status=='Processing'?'selected':''}>Processing</option>
                            <option value="Ready" ${row.status=='Ready'?'selected':''}>Ready</option>
                            <option value="Delivered" ${row.status=='Delivered'?'selected':''}>Delivered</option>
                        </select>
                    </td>
                    <td><a href="${wa}" target="_blank" class="wa-btn">WhatsApp</a></td>
                </tr>`;
            });
            document.getElementById('results').innerHTML = html + "</table>";
        });
    }

    function updateStatus(row, status) {
        fetch(`${scriptURL}?action=updateStatus&row=${row}&status=${status}`).then(() => Swal.fire("Updated", "Status Changed", "success"));
    }

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);
</script>
</body>
</html>
