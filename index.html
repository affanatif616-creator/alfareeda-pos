<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alfareeda Opticals | POS Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --navy: #1a2a47; --gold: #f89e1b; --green: #25D366; --red: #d9534f; --light: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f7; margin: 0; padding: 20px; color: #333; }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border-top: 5px solid var(--gold); box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .stat-card h4 { margin: 0; font-size: 13px; color: #777; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card p { margin: 10px 0 0; font-size: 28px; font-weight: bold; color: var(--navy); }

        .main-grid { display: grid; grid-template-columns: 400px 1fr; gap: 25px; max-width: 1200px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        h3 { margin-top: 0; font-size: 18px; border-bottom: 2px solid var(--light); padding-bottom: 10px; margin-bottom: 20px; color: var(--navy); }
        label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 5px; color: #666; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; margin-bottom: 15px; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 15px; }
        .btn-save { background: var(--navy); color: white; }
        .btn-exp { background: var(--red); color: white; margin-top: 10px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: var(--light); padding: 12px; text-align: left; font-size: 12px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        .wa-btn { background: var(--green); color: white; text-decoration: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; display: inline-block; }
    </style>
</head>
<body>

<div class="stats-grid">
    <div class="stat-card"><h4>Sales Today</h4><p id="statSales">Loading...</p></div>
    <div class="stat-card" style="border-top-color: var(--red)"><h4>Expenses</h4><p id="statExp">Loading...</p></div>
    <div class="stat-card" style="border-top-color: var(--green)"><h4>Net Profit</h4><p id="statProfit">Loading...</p></div>
</div>

<div class="main-grid">
    <div class="side-panel">
        <div class="card">
            <h3>New Order Entry</h3>
            <label>CUSTOMER NAME</label><input type="text" id="custName">
            <label>CONTACT NUMBER</label><input type="text" id="custPhone">
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>RE</label><input type="text" id="re"></div>
                <div style="flex:1"><label>LE</label><input type="text" id="le"></div>
            </div>
            <label>ITEMS/DETAILS</label><textarea id="items" rows="2"></textarea>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>TOTAL</label><input type="number" id="total" oninput="doMath()"></div>
                <div style="flex:1"><label>ADVANCE</label><input type="number" id="advance" oninput="doMath()"></div>
            </div>
            <label>BALANCE DUE</label><input type="number" id="balance" readonly style="background:#f0f0f0; font-weight:bold; color:red;">
            <button class="btn btn-save" onclick="saveSale()">SAVE & CREATE INVOICE</button>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>Shop Expense</h3>
            <label>CATEGORY</label>
            <select id="expCat"><option>Stock</option><option>Rent</option><option>Salary</option><option>Utility</option></select>
            <label>DESCRIPTION</label><input type="text" id="expDesc">
            <label>AMOUNT (OMR)</label><input type="number" id="expAmount">
            <button class="btn btn-exp" onclick="saveExpense()">RECORD EXPENSE</button>
        </div>
    </div>

    <div class="card">
        <h3>Search & Manage Orders</h3>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="searchPhone" placeholder="Enter phone number..." style="margin-bottom:0;">
            <button class="btn btn-save" style="width:120px;" onclick="search()">Search</button>
        </div>
        <div id="results">
            <p style="text-align:center; color:#999; margin-top:50px;">Use the search bar to find customer history.</p>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzoLcUg-r7YO_OWEOyDLNYSkaISefZ-twe6LCibM5uvOrG0W4m0g5pY4yT9Rs4Z2WuKcw/exec'; 

    // --- 2. INITIAL LOAD (The Memory Fix) ---
    window.onload = function() {
        fetch(`${scriptURL}?action=getStats`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('statSales').innerText = "OMR " + parseFloat(data.sales).toFixed(3);
            document.getElementById('statExp').innerText = "OMR " + parseFloat(data.expenses).toFixed(3);
            document.getElementById('statProfit').innerText = "OMR " + (data.sales - data.expenses).toFixed(3);
        })
        .catch(err => {
            document.getElementById('statSales').innerText = "OMR 0.000";
            document.getElementById('statExp').innerText = "OMR 0.000";
            document.getElementById('statProfit').innerText = "OMR 0.000";
        });
    };

    // --- 3. MATH UTILITY ---
    function doMath() {
        const t = parseFloat(document.getElementById('total').value) || 0;
        const a = parseFloat(document.getElementById('advance').value) || 0;
        document.getElementById('balance').value = (t - a).toFixed(3);
    }

    // --- 4. SAVE SALE (With Auto-Refresh) ---
    function saveSale() {
        const name = document.getElementById('custName').value;
        const total = document.getElementById('total').value;
        if(!name || !total) return Swal.fire("Required", "Please enter Name and Total", "warning");

        const params = `action=saveSale&name=${encodeURIComponent(name)}&phone=${document.getElementById('custPhone').value}&re=${document.getElementById('re').value}&le=${document.getElementById('le').value}&items=${encodeURIComponent(document.getElementById('items').value)}&total=${total}&advance=${document.getElementById('advance').value}&balance=${document.getElementById('balance').value}&payment=Cash`;

        Swal.fire({ title: 'Processing Sale...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });

        fetch(`${scriptURL}?${params}`).then(res => res.json()).then(data => {
            Swal.fire("Success", "Order " + data.inv + " Saved!", "success").then(() => {
                location.reload(); // REFRESH TO CLEAR FORM AND UPDATE DASHBOARD
            });
        });
    }

    // --- 5. SAVE EXPENSE (With Auto-Refresh) ---
    function saveExpense() {
        const amt = document.getElementById('expAmount').value;
        if(!amt) return;
        
        const params = `action=saveExpense&category=${document.getElementById('expCat').value}&desc=${encodeURIComponent(document.getElementById('expDesc').value)}&amount=${amt}`;
        
        fetch(`${scriptURL}?${params}`).then(() => {
            Swal.fire("Recorded", "Expense saved successfully", "success").then(() => {
                location.reload(); // REFRESH TO UPDATE DASHBOARD
            });
        });
    }

    // --- 6. SEARCH & UPDATE ---
    function search() {
        const phone = document.getElementById('searchPhone').value;
        document.getElementById('results').innerHTML = "<p style='text-align:center;'>Searching Alfareeda Database...</p>";
        
        fetch(`${scriptURL}?phone=${phone}`).then(res => res.json()).then(data => {
            if(data.length === 0) {
                document.getElementById('results').innerHTML = "<p style='text-align:center;'>No records found.</p>";
                return;
            }
            let html = `<table><tr><th>Inv #</th><th>Name</th><th>Balance</th><th>Status</th><th>WhatsApp</th></tr>`;
            data.forEach(r => {
                let wa = `https://wa.me/${r.contact}?text=Hello ${r.name}, your order ${r.invoice} from Alfareeda Opticals is ${r.status}. Balance: OMR ${r.balance}`;
                html += `<tr>
                    <td><b>${r.invoice}</b></td>
                    <td>${r.name}</td>
                    <td style="color:red; font-weight:bold;">${parseFloat(r.balance).toFixed(3)}</td>
                    <td>
                        <select onchange="updateStatus(${r.row}, this.value)" style="margin:0; padding:5px;">
                            <option value="Processing" ${r.status=='Processing'?'selected':''}>Processing</option>
                            <option value="Ready" ${r.status=='Ready'?'selected':''}>Ready</option>
                            <option value="Delivered" ${r.status=='Delivered'?'selected':''}>Delivered</option>
                        </select>
                    </td>
                    <td><a href="${wa}" target="_blank" class="wa-btn">Send Msg</a></td>
                </tr>`;
            });
            document.getElementById('results').innerHTML = html + "</table>";
        });
    }

    function updateStatus(row, status) {
        fetch(`${scriptURL}?action=updateStatus&row=${row}&status=${status}`)
        .then(() => Swal.fire({ title: "Updated", text: "Status changed successfully", icon: "success", toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 }));
    }
</script>
</body>
</html>
