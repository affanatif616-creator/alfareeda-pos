<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alfareeda Opticals | Pro POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --success: #10b981; --danger: #f43f5e; --bg: #f8fafc; --sidebar-w: 260px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #1e293b; display: flex; min-height: 100vh; }

        /* --- UI COMPONENTS --- */
        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-card { background: white; padding: 2.5rem; border-radius: 20px; width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        .sidebar { width: var(--sidebar-w); background: var(--primary); color: white; position: fixed; height: 100vh; padding: 2rem 1rem; display: none; flex-direction: column; }
        .main-content { margin-left: var(--sidebar-w); padding: 2.5rem; width: 100%; display: none; }
        .data-card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        
        /* --- FORMS --- */
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #64748b; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; font-family: inherit; }
        input:focus { outline: 2px solid var(--accent); border-color: transparent; }
        .btn-primary { background: var(--accent); color: white; border: none; width: 100%; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; }

        /* --- NAVIGATION --- */
        .nav-item { display: flex; align-items: center; gap: 12px; color: #94a3b8; padding: 12px 16px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; text-decoration: none; }
        .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--accent); }

        /* --- TABLES --- */
        .rx-table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .rx-table th { background: #f1f5f9; padding: 10px; font-size: 0.75rem; color: #64748b; }
        .rx-table td { background: white; padding: 5px; border: 1px solid #f1f5f9; }
        .rx-table input { border: none; text-align: center; padding: 8px; }
    </style>
</head>
<body>

    <div id="login-overlay" class="login-screen">
        <div class="login-card">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--accent);">ALFAREEDA LOGIN</h2>
            <div class="form-group"><label>Branch</label>
                <select id="login-branch"><option>Sumail</option><option>Izki</option><option>Sinaw</option></select>
            </div>
            <div class="form-group"><label>Staff ID</label><input type="text" id="username"></div>
            <div class="form-group"><label>Password</label><input type="password" id="password"></div>
            <button class="btn-primary" id="login-btn" onclick="handleLogin()">Login to Cloud</button>
        </div>
    </div>

    <aside id="sidebar" class="sidebar">
        <div style="font-size: 1.5rem; font-weight: 800; color: var(--accent); margin-bottom: 2rem;"><i class="fas fa-glasses"></i> ALFAREEDA</div>
        <nav style="flex-grow: 1;">
            <div class="nav-item active" onclick="showSection('dash')"><i class="fas fa-th-large"></i> Dashboard</div>
            <div class="nav-item" onclick="showSection('order')"><i class="fas fa-plus-circle"></i> New Sale Record</div>
            <div class="nav-item" onclick="showSection('order-list'); loadOrderList();">
    <i class="fas fa-list-ul"></i> <span>Order List</span>
</div>
            <div class="nav-item" id="nav-staff" style="display:none;" onclick="showSection('staff-mgr')"><i class="fas fa-user-shield"></i> Staff Management</div>
        </nav>
        <div class="nav-item" onclick="logout(event)" style="color:var(--danger); border-top:1px solid #334155; padding-top:20px;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </div>
    </aside>

    <main id="main-content" class="main-content">
        <header style="margin-bottom: 30px;">
            <h1 id="branch-display">Branch</h1>
            <p id="staff-display" style="color: #64748b;"></p>
        </header>

        <div id="dash-section" class="content-section">
            <div class="data-card">
                <h3>Welcome to Alfareeda POS</h3>
                <p style="margin-top:10px; color:#64748b;">Select "New Sale Record" to start entering customer orders.</p>
            </div>
        </div>

        <div id="order-section" class="content-section" style="display:none;">
            <div class="data-card">
                <h2><i class="fas fa-file-invoice"></i> Daily Sale Entry</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top:20px;">
                    <div class="form-group"><label>Invoice Number</label><input type="text" id="order-invoice"></div>
                    <div class="form-group"><label>Customer Name</label><input type="text" id="order-name"></div>
                    <div class="form-group"><label>Contact</label><input type="text" id="order-contact"></div>
                </div>

                <h3 style="font-size: 0.85rem; color: var(--accent); margin-top: 15px;">PRESCRIPTION DETAILS</h3>
                <table class="rx-table">
                    <thead><tr><th>EYE</th><th>SPH</th><th>CYL</th><th>AXIS</th><th>ADD</th></tr></thead>
                    <tbody>
                        <tr><td><strong>RE</strong></td>
                            <td><input type="text" id="re-sph" placeholder="0.00"></td>
                            <td><input type="text" id="re-cyl" placeholder="0.00"></td>
                            <td><input type="text" id="re-axis" placeholder="0"></td>
                            <td><input type="text" id="re-add" placeholder="0.00"></td>
                        </tr>
                        <tr><td><strong>LE</strong></td>
                            <td><input type="text" id="le-sph" placeholder="0.00"></td>
                            <td><input type="text" id="le-cyl" placeholder="0.00"></td>
                            <td><input type="text" id="le-axis" placeholder="0"></td>
                            <td><input type="text" id="le-add" placeholder="0.00"></td>
                        </tr>
                    </tbody>
                </table>

                <div class="form-group"><label>Items (Frame & Lens details)</label><input type="text" id="order-items"></div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group"><label>Total</label><input type="number" id="order-total" step="0.001" oninput="calcBalance()"></div>
                    <div class="form-group"><label>Advance</label><input type="number" id="order-advance" step="0.001" oninput="calcBalance()"></div>
                    <div class="form-group"><label>Balance</label><input type="number" id="order-balance" readonly style="background:#f1f5f9;"></div>
                    <div class="form-group"><label>Payment</label>
                        <select id="order-payment"><option>Cash</option><option>Bank Transfer</option><option>Card</option></select>
                    </div>
                </div>

                <div class="form-group"><label>Status</label>
                    <select id="order-status"><option>Processing</option><option>Ready</option><option>Delivered</option></select>
                </div>

                <button class="btn-primary" id="save-btn" onclick="saveOrderToCloud()">Save Record to Google Sheet</button>
            </div>
        </div>

        <div id="staff-mgr-section" class="content-section" style="display:none;">
            <div class="data-card">
                <h3>Add New Staff Member</h3><br>
                <div class="form-group"><label>Full Name</label><input type="text" id="new-name"></div>
                <div class="form-group"><label>Username</label><input type="text" id="new-id"></div>
                <div class="form-group"><label>Password</label><input type="password" id="new-pass"></div>
                <div class="form-group"><label>Branch</label>
                    <select id="new-branch"><option>Sumail</option><option>Izki</option><option>Sinaw</option></select>
                </div>
                <button class="btn-primary" onclick="createNewStaff()">Create Cloud Account</button>
            </div>
        </div>

<div id="order-list-section" class="content-section" style="display:none;">
    <div class="data-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2><i class="fas fa-history"></i> Recent Orders</h2>
            <input type="text" 
       id="search-box" 
       oninput="searchOrders()" 
       placeholder="Search Name, Mobile or Invoice..." 
       style="width: 250px; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
        </div>
        
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
    <tr style="background: #f1f5f9; text-align: left;">
        <th style="padding: 12px;">Date</th>
        <th style="padding: 12px;">Invoice</th>
        <th style="padding: 12px;">Name</th>
        <th style="padding: 12px;">Number</th>
        <th style="padding: 12px;">Balance</th>
        <th style="padding: 12px;">Status</th>
        <th style="padding: 12px; text-align:right;">Actions</th>
    </tr>
</thead>
<tbody id="order-list-table"></tbody>
            </table>
        </div>
    </div>
</div>

    </main>
<div id="edit-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center;">
    <div class="data-card" style="width:350px; background:white; padding:20px; border-radius:15px;">
        <h3 style="margin-bottom:15px;">Update Order</h3>
        
        <div class="form-group">
            <label>Invoice Number</label>
            <input type="text" id="up-invoice" readonly style="background:#f1f5f9; cursor:not-allowed;">
        </div>

        <div class="form-group" style="margin-top:10px;">
            <label>Order Status</label>
            <select id="up-status">
                <option value="Pending">Pending</option>
                <option value="Ready">Ready</option>
                <option value="Delivered">Delivered</option>
            </select>
        </div>

        <div class="form-group" style="margin-top:10px;">
            <label>Remaining Balance (OMR)</label>
            <input type="number" id="up-balance" step="0.001">
        </div>

        <div style="margin-top:20px;">
            <button class="btn-primary" onclick="submitUpdate()">Save Changes</button>
            <button onclick="closeModals()" style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer; color:#64748b;">Cancel</button>
        </div>
    </div>
</div>

<div id="rx-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10001; align-items:center; justify-content:center;">
    <div class="data-card" style="width:400px; background:white; padding:25px; border-radius:15px;">
        <div id="rx-body"></div>
        <button class="btn-primary" style="margin-top:20px;" onclick="closeModals()">Close</button>
    </div>
</div>


    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbywSYeS2XoS1YJkHvN4JQKzwSDj6gdvJLaZZSHFcyumZOuyGSl7AXgWLRGYvGHMxtBRwg/exec'; // <--- PUT YOUR URL HERE
        let staffList = [];
        let logoutTimer;

        // --- SECURITY & SESSION ---
        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            if (sessionStorage.getItem('alfareeda_user')) {
                logoutTimer = setTimeout(() => { alert("Session Expired (30 mins)"); logout(); }, 30 * 60 * 1000);
            }
        }
        ['mousedown', 'mousemove', 'keypress'].forEach(e => document.addEventListener(e, resetLogoutTimer));

        async function loadStaff() {
            try {
                const res = await fetch(scriptURL + "?type=staff");
                const data = await res.json();
                staffList = data.map(r => ({ name:r[0], id:r[1], pass:r[2], branch:r[3], role:r[4] }));
                staffList.push({ id:"admin", pass:"alf123", role:"Manager", branch:"All", name:"Master Admin" });
            } catch(e) { staffList = [{ id:"admin", pass:"alf123", role:"Manager", branch:"All" }]; }
        }

        async function handleLogin() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            const branch = document.getElementById('login-branch').value;
            const btn = document.getElementById('login-btn');
            
            btn.disabled = true; btn.innerText = "Connecting...";
            await loadStaff();

            const auth = staffList.find(s => s.id == user && s.pass == pass);
            if (auth && (auth.role === "Manager" || auth.branch === branch)) {
                const sessionData = { ...auth, activeBranch: branch };
                sessionStorage.setItem('alfareeda_user', JSON.stringify(sessionData));
                applyUI(sessionData);
            } else {
                alert("Login Failed");
                btn.disabled = false; btn.innerText = "Login to Cloud";
            }
        }

       function applyUI(auth) {
    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('sidebar').style.display = 'flex';
    document.getElementById('main-content').style.display = 'block';
    document.getElementById('branch-display').innerText = auth.activeBranch + " Records";
    document.getElementById('staff-display').innerText = "Logged in as: " + (auth.name || auth.id);
    if(auth.role === "Manager") document.getElementById('nav-staff').style.display = 'flex';
    
    loadBranchStats(auth.role, auth.activeBranch); // Call stats
    resetLogoutTimer();
}


        // --- BUSINESS LOGIC ---
        function calcBalance() {
            const t = parseFloat(document.getElementById('order-total').value) || 0;
            const a = parseFloat(document.getElementById('order-advance').value) || 0;
            document.getElementById('order-balance').value = (t - a).toFixed(3);
        }

        async function saveOrderToCloud() {
    const btn = document.getElementById('save-btn');
    const sessionUser = JSON.parse(sessionStorage.getItem('alfareeda_user'));

    if (!sessionUser) return alert("Please log in again.");

    const rePower = `S:${document.getElementById('re-sph').value || '0'} C:${document.getElementById('re-cyl').value || '0'} A:${document.getElementById('re-axis').value || '0'} Add:${document.getElementById('re-add').value || '0'}`;
    const lePower = `S:${document.getElementById('le-sph').value || '0'} C:${document.getElementById('le-cyl').value || '0'} A:${document.getElementById('le-axis').value || '0'} Add:${document.getElementById('le-add').value || '0'}`;

    const data = {
        type: "order",
        invoice: document.getElementById('order-invoice').value,
        name: document.getElementById('order-name').value,
        contact: document.getElementById('order-contact').value,
        rightEye: rePower,
        leftEye: lePower,
        items: document.getElementById('order-items').value,
        total: document.getElementById('order-total').value || 0,
        advance: document.getElementById('order-advance').value || 0,
        balance: document.getElementById('order-balance').value || 0,
        payment: document.getElementById('order-payment').value,
        status: document.getElementById('order-status').value,
        branch: sessionUser.activeBranch // Crucial for filtering
    };

    if(!data.name || !data.invoice) return alert("Fill Name and Invoice");

    btn.disabled = true;
    btn.innerText = "Syncing with Cloud...";

    try {
        await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
        alert("Saved to " + sessionUser.activeBranch);
        location.reload();
    } catch(e) {
        alert("Error!");
        btn.disabled = false;
        btn.innerText = "Save Record";
    }
}

        async function createNewStaff() {
            const data = {
                type: "staff",
                name: document.getElementById('new-name').value,
                id: document.getElementById('new-id').value,
                pass: document.getElementById('new-pass').value,
                branch: document.getElementById('new-branch').value,
                role: "Cashier"
            };
            await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            alert("Staff Added"); location.reload();
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.getElementById(id + '-section').style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function logout(e) { 
            if(confirm("Logout?")) { sessionStorage.removeItem('alfareeda_user'); location.reload(); }
        }

async function loadOrderList() {
    const tableBody = document.getElementById('order-list-table');
    const user = JSON.parse(sessionStorage.getItem('alfareeda_user'));
    
    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Fetching Cloud Records...</td></tr>';

    try {
        const res = await fetch(scriptURL + "?type=records");
        const allRecords = await res.json();
        
        // Filter: Manager sees all, Branch sees only theirs
        const displayRecords = (user.role === "Manager") 
            ? allRecords 
            : allRecords.filter(r => r[12] === user.activeBranch);

        displayRecords.reverse(); // Newest first

        tableBody.innerHTML = '';
        displayRecords.forEach(row => {
            const dateStr = new Date(row[0]).toLocaleDateString('en-GB');
            const inv = row[1];
            const name = row[2];
            const phone = row[3];
            const balance = parseFloat(row[9]) || 0;
            const status = row[11];
            
            // Prescription data for the "View RX" button
            const rxData = JSON.stringify({
                name: name,
                invoice: inv,
                re: row[4],
                le: row[5],
                items: row[6]
            }).replace(/"/g, '&quot;');

            // Status Badge Color
            let badgeColor = status === 'Delivered' ? '#10b981' : (status === 'Ready' ? '#3b82f6' : '#f59e0b');

            tableBody.innerHTML += `
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 12px;">${dateStr}</td>
                    <td style="padding: 12px; font-weight:600;">${inv}</td>
                    <td style="padding: 12px;">${name}</td>
                    <td style="padding: 12px; color:#64748b;">${phone}</td>
                    <td style="padding: 12px; font-weight:bold; color:${balance > 0 ? '#f43f5e' : '#10b981'};">
                        ${balance.toFixed(3)}
                    </td>
                    <td style="padding: 12px;">
                        <span style="background:${badgeColor}22; color:${badgeColor}; padding:4px 10px; border-radius:12px; font-size:0.75rem; font-weight:bold;">
                            ${status}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align:right; display:flex; gap:8px; justify-content:flex-end;">
                        <button onclick="showRx('${rxData}')" title="View Prescription" style="background:#f1f5f9; color:#475569; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="openEditModal('${inv}', '${balance}', '${status}')" title="Edit Order" style="background:var(--accent); color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    } catch (e) {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">Connection Error</td></tr>';
    }
}

function searchOrders() {
    const input = document.getElementById('search-box').value.toLowerCase();
    const table = document.querySelector('table');
    const tr = table.getElementsByTagName('tr');

    // Loop through all table rows (starting from index 1 to skip the header)
    for (let i = 1; i < tr.length; i++) {
        const nameCell = tr[i].getElementsByTagName('td')[2]; // Column 3 is Name
        const invCell = tr[i].getElementsByTagName('td')[1];  // Column 2 is Invoice
        
        if (nameCell || invCell) {
            const nameText = nameCell.textContent.toLowerCase();
            const invText = invCell.textContent.toLowerCase();
            
            // If the name or invoice matches the search input, show the row
            if (nameText.indexOf(input) > -1 || invText.indexOf(input) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }
}


        window.onload = async () => {
            const saved = sessionStorage.getItem('alfareeda_user');
            if(saved) applyUI(JSON.parse(saved));
            await loadStaff();
        };

async function loadBranchStats(userRole, myBranch) {
    try {
        const res = await fetch(scriptURL + "?type=records");
        const allRecords = await res.json();
        const dashContainer = document.getElementById('dash-section');

        // CASE 1: MANAGER VIEW (Show all branches)
        if (userRole === "Manager") {
            const branches = ["Sumail", "Izki", "Sinaw"];
            let htmlContent = `<h3 style="margin-bottom:20px; color:var(--accent);">All Branches Overview</h3>
                               <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">`;

            branches.forEach(b => {
                const branchData = allRecords.filter(r => r[12] === b);
                let total = 0, bal = 0;
                branchData.forEach(row => {
                    total += parseFloat(row[7]) || 0;
                    bal += parseFloat(row[9]) || 0;
                });

                htmlContent += `
                    <div class="data-card" style="border-top: 5px solid var(--accent);">
                        <h4 style="color:var(--primary);">${b} Branch</h4>
                        <hr style="margin:10px 0; opacity:0.1;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-size:0.8rem; color:#64748b;">Total Sales:</span>
                            <span style="font-weight:700;">${total.toFixed(3)} OMR</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-size:0.8rem; color:#64748b;">Pending Bal:</span>
                            <span style="font-weight:700; color:var(--danger);">${bal.toFixed(3)} OMR</span>
                        </div>
                    </div>`;
            });

            htmlContent += `</div>`;
            dashContainer.innerHTML = htmlContent;

        // CASE 2: CASHIER VIEW (Show only their branch)
        } else {
            const myBranchSales = allRecords.filter(r => r[12] === myBranch);
            let totalRevenue = 0, pendingBalance = 0;

            myBranchSales.forEach(row => {
                totalRevenue += parseFloat(row[7]) || 0;
                pendingBalance += parseFloat(row[9]) || 0;
            });

            dashContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="data-card" style="border-left: 5px solid var(--success);">
                        <label style="color:#64748b; font-size:0.8rem; font-weight:bold;">TOTAL SALES (${myBranch})</label>
                        <h2 style="font-size: 2rem; color: #0f172a;">${totalRevenue.toFixed(3)} OMR</h2>
                    </div>
                    <div class="data-card" style="border-left: 5px solid var(--danger);">
                        <label style="color:#64748b; font-size:0.8rem; font-weight:bold;">PENDING BALANCE</label>
                        <h2 style="font-size: 2rem; color: #f43f5e;">${pendingBalance.toFixed(3)} OMR</h2>
                    </div>
                </div>`;
        }
    } catch (e) {
        console.log("Stats error:", e);
    }
}
// This function opens the Edit window when the pencil icon is clicked
function openEditModal(inv, bal, stat) {
    const modal = document.getElementById('edit-modal');
    const invField = document.getElementById('up-invoice');
    const balField = document.getElementById('up-balance');
    const statField = document.getElementById('up-status');

    if (modal && invField && balField && statField) {
        invField.value = inv;
        balField.value = bal;
        statField.value = stat;
        modal.style.display = 'flex';
    } else {
        console.error("One or more Edit Modal elements are missing from HTML");
    }
}

// This function sends the updated status and balance to your Google Sheet
async function submitUpdate() {
    const inv = document.getElementById('up-invoice').value;
    const bal = document.getElementById('up-balance').value;
    const stat = document.getElementById('up-status').value;

    if (!inv) {
        alert("Error: Invoice number is missing.");
        return;
    }

    // Change button text to show it's working
    const btn = event.target;
    const originalText = btn.innerText;
    btn.innerText = "Updating Cloud...";
    btn.disabled = true;

    const data = {
        action: "update",
        invoice: inv,
        balance: bal,
        status: stat
    };

    try {
        // Send to your Google Apps Script URL
        await fetch(scriptURL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(data) 
        });

        alert("Order " + inv + " updated successfully!");
        closeModals();
        location.reload(); // Refresh to show new balance/status
    } catch (e) {
        console.error("Update Error:", e);
        alert("Connection Error. Please try again.");
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

// This function handles the "Prescription" button
function showRx(jsonStr) {
    const modal = document.getElementById('rx-modal');
    const body = document.getElementById('rx-body');
    
    // Parse the JSON string back into an object
    const data = JSON.parse(jsonStr);

    if (modal && body) {
        body.innerHTML = `
            <h2 style="color:var(--accent); margin-bottom:15px;">Prescription Card</h2>
            <p><strong>Customer:</strong> ${data.name}</p>
            <p><strong>Invoice:</strong> ${data.invoice}</p>
            <hr style="margin:15px 0; opacity:0.1;">
            <div style="background:#f8fafc; padding:15px; border-radius:8px; line-height:1.6;">
                <p><strong>Right Eye (RE):</strong><br> ${data.re || 'N/A'}</p>
                <p style="margin-top:10px;"><strong>Left Eye (LE):</strong><br> ${data.le || 'N/A'}</p>
            </div>
            <div style="margin-top:15px;">
                <p><strong>Lens/Items:</strong><br> ${data.items || 'None'}</p>
            </div>
        `;
        modal.style.display = 'flex';
    }
}

// Function to close any open popup
function closeModals() {
    if(document.getElementById('rx-modal')) document.getElementById('rx-modal').style.display = 'none';
    if(document.getElementById('edit-modal')) document.getElementById('edit-modal').style.display = 'none';
}

function searchOrders() {
    // 1. Get the search input
    const input = document.getElementById('search-box');
    if (!input) return;
    const filter = input.value.toLowerCase();
    
    // 2. Target YOUR specific table body ID
    const tableBody = document.getElementById('order-list-table');
    if (!tableBody) return;

    // 3. Get all rows inside that table body
    const rows = tableBody.getElementsByTagName('tr');

    // 4. Loop through the rows
    for (let i = 0; i < rows.length; i++) {
        // Get the text from Name (3rd column) and Invoice (2nd column)
        const rowText = rows[i].textContent || rows[i].innerText;
        
        if (rowText.toLowerCase().indexOf(filter) > -1) {
            rows[i].style.display = ""; // Show
        } else {
            rows[i].style.display = "none"; // Hide
        }
    }
}

    </script>

</body>
</html>
