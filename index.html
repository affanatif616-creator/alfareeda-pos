<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alfareeda Opticals | Pro POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --success: #10b981; --danger: #f43f5e; --bg: #f8fafc; --sidebar-w: 260px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #1e293b; display: flex; min-height: 100vh; }

        /* --- UI COMPONENTS --- */
        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-card { background: white; padding: 2.5rem; border-radius: 20px; width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        .sidebar { width: var(--sidebar-w); background: var(--primary); color: white; position: fixed; height: 100vh; padding: 2rem 1rem; display: none; flex-direction: column; }
        .main-content { margin-left: var(--sidebar-w); padding: 2.5rem; width: 100%; display: none; }
        .data-card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        
        /* --- FORMS --- */
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #64748b; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; font-family: inherit; }
        input:focus { outline: 2px solid var(--accent); border-color: transparent; }
        .btn-primary { background: var(--accent); color: white; border: none; width: 100%; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; }

        /* --- NAVIGATION --- */
        .nav-item { display: flex; align-items: center; gap: 12px; color: #94a3b8; padding: 12px 16px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; text-decoration: none; }
        .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--accent); }

        /* --- TABLES --- */
        .rx-table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .rx-table th { background: #f1f5f9; padding: 10px; font-size: 0.75rem; color: #64748b; }
        .rx-table td { background: white; padding: 5px; border: 1px solid #f1f5f9; }
        .rx-table input { border: none; text-align: center; padding: 8px; }
    </style>
</head>
<body>

    <div id="login-overlay" class="login-screen">
        <div class="login-card">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--accent);">ALFAREEDA LOGIN</h2>
            <div class="form-group"><label>Branch</label>
                <select id="login-branch"><option>Sumail</option><option>Izki</option><option>Sinaw</option></select>
            </div>
            <div class="form-group"><label>Staff ID</label><input type="text" id="username"></div>
            <div class="form-group"><label>Password</label><input type="password" id="password"></div>
            <button class="btn-primary" id="login-btn" onclick="handleLogin()">Login to Cloud</button>
        </div>
    </div>

    <aside id="sidebar" class="sidebar">
        <div style="font-size: 1.5rem; font-weight: 800; color: var(--accent); margin-bottom: 2rem;"><i class="fas fa-glasses"></i> ALFAREEDA</div>
        <nav style="flex-grow: 1;">
            <div class="nav-item active" onclick="showSection('dash')"><i class="fas fa-th-large"></i> Dashboard</div>
            <div class="nav-item" onclick="showSection('order')"><i class="fas fa-plus-circle"></i> New Sale Record</div>
            <div class="nav-item" id="nav-staff" style="display:none;" onclick="showSection('staff-mgr')"><i class="fas fa-user-shield"></i> Staff Management</div>
        </nav>
        <div class="nav-item" onclick="logout(event)" style="color:var(--danger); border-top:1px solid #334155; padding-top:20px;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </div>
    </aside>

    <main id="main-content" class="main-content">
        <header style="margin-bottom: 30px;">
            <h1 id="branch-display">Branch</h1>
            <p id="staff-display" style="color: #64748b;"></p>
        </header>

        <div id="dash-section" class="content-section">
            <div class="data-card">
                <h3>Welcome to Alfareeda POS</h3>
                <p style="margin-top:10px; color:#64748b;">Select "New Sale Record" to start entering customer orders.</p>
            </div>
        </div>

        <div id="order-section" class="content-section" style="display:none;">
            <div class="data-card">
                <h2><i class="fas fa-file-invoice"></i> Daily Sale Entry</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top:20px;">
                    <div class="form-group"><label>Invoice Number</label><input type="text" id="order-invoice"></div>
                    <div class="form-group"><label>Customer Name</label><input type="text" id="order-name"></div>
                    <div class="form-group"><label>Contact</label><input type="text" id="order-contact"></div>
                </div>

                <h3 style="font-size: 0.85rem; color: var(--accent); margin-top: 15px;">PRESCRIPTION DETAILS</h3>
                <table class="rx-table">
                    <thead><tr><th>EYE</th><th>SPH</th><th>CYL</th><th>AXIS</th><th>ADD</th></tr></thead>
                    <tbody>
                        <tr><td><strong>RE</strong></td>
                            <td><input type="text" id="re-sph" placeholder="0.00"></td>
                            <td><input type="text" id="re-cyl" placeholder="0.00"></td>
                            <td><input type="text" id="re-axis" placeholder="0"></td>
                            <td><input type="text" id="re-add" placeholder="0.00"></td>
                        </tr>
                        <tr><td><strong>LE</strong></td>
                            <td><input type="text" id="le-sph" placeholder="0.00"></td>
                            <td><input type="text" id="le-cyl" placeholder="0.00"></td>
                            <td><input type="text" id="le-axis" placeholder="0"></td>
                            <td><input type="text" id="le-add" placeholder="0.00"></td>
                        </tr>
                    </tbody>
                </table>

                <div class="form-group"><label>Items (Frame & Lens details)</label><input type="text" id="order-items"></div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group"><label>Total</label><input type="number" id="order-total" step="0.001" oninput="calcBalance()"></div>
                    <div class="form-group"><label>Advance</label><input type="number" id="order-advance" step="0.001" oninput="calcBalance()"></div>
                    <div class="form-group"><label>Balance</label><input type="number" id="order-balance" readonly style="background:#f1f5f9;"></div>
                    <div class="form-group"><label>Payment</label>
                        <select id="order-payment"><option>Cash</option><option>Bank Transfer</option><option>Card</option></select>
                    </div>
                </div>

                <div class="form-group"><label>Status</label>
                    <select id="order-status"><option>Processing</option><option>Ready</option><option>Delivered</option></select>
                </div>

                <button class="btn-primary" id="save-btn" onclick="saveOrderToCloud()">Save Record to Google Sheet</button>
            </div>
        </div>

        <div id="staff-mgr-section" class="content-section" style="display:none;">
            <div class="data-card">
                <h3>Add New Staff Member</h3><br>
                <div class="form-group"><label>Full Name</label><input type="text" id="new-name"></div>
                <div class="form-group"><label>Username</label><input type="text" id="new-id"></div>
                <div class="form-group"><label>Password</label><input type="password" id="new-pass"></div>
                <div class="form-group"><label>Branch</label>
                    <select id="new-branch"><option>Sumail</option><option>Izki</option><option>Sinaw</option></select>
                </div>
                <button class="btn-primary" onclick="createNewStaff()">Create Cloud Account</button>
            </div>
        </div>
    </main>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwCnbluvZp5rmGIw_iaZRh1SYvX1UFeSV9rz5TLwzT_5HwrJZlU6P29A2o8M0ALKHhdFw/exec'; // <--- PUT YOUR URL HERE
        let staffList = [];
        let logoutTimer;

        // --- SECURITY & SESSION ---
        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            if (sessionStorage.getItem('alfareeda_user')) {
                logoutTimer = setTimeout(() => { alert("Session Expired (30 mins)"); logout(); }, 30 * 60 * 1000);
            }
        }
        ['mousedown', 'mousemove', 'keypress'].forEach(e => document.addEventListener(e, resetLogoutTimer));

        async function loadStaff() {
            try {
                const res = await fetch(scriptURL + "?type=staff");
                const data = await res.json();
                staffList = data.map(r => ({ name:r[0], id:r[1], pass:r[2], branch:r[3], role:r[4] }));
                staffList.push({ id:"admin", pass:"alf123", role:"Manager", branch:"All", name:"Master Admin" });
            } catch(e) { staffList = [{ id:"admin", pass:"alf123", role:"Manager", branch:"All" }]; }
        }

        async function handleLogin() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            const branch = document.getElementById('login-branch').value;
            const btn = document.getElementById('login-btn');
            
            btn.disabled = true; btn.innerText = "Connecting...";
            await loadStaff();

            const auth = staffList.find(s => s.id == user && s.pass == pass);
            if (auth && (auth.role === "Manager" || auth.branch === branch)) {
                const sessionData = { ...auth, activeBranch: branch };
                sessionStorage.setItem('alfareeda_user', JSON.stringify(sessionData));
                applyUI(sessionData);
            } else {
                alert("Login Failed");
                btn.disabled = false; btn.innerText = "Login to Cloud";
            }
        }

       function applyUI(auth) {
    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('sidebar').style.display = 'flex';
    document.getElementById('main-content').style.display = 'block';
    document.getElementById('branch-display').innerText = auth.activeBranch + " Records";
    document.getElementById('staff-display').innerText = "Logged in as: " + (auth.name || auth.id);
    if(auth.role === "Manager") document.getElementById('nav-staff').style.display = 'flex';
    
    loadBranchStats(auth.role, auth.activeBranch); // Call stats
    resetLogoutTimer();
}


        // --- BUSINESS LOGIC ---
        function calcBalance() {
            const t = parseFloat(document.getElementById('order-total').value) || 0;
            const a = parseFloat(document.getElementById('order-advance').value) || 0;
            document.getElementById('order-balance').value = (t - a).toFixed(3);
        }

        async function saveOrderToCloud() {
    const btn = document.getElementById('save-btn');
    const sessionUser = JSON.parse(sessionStorage.getItem('alfareeda_user'));

    if (!sessionUser) return alert("Please log in again.");

    const rePower = `S:${document.getElementById('re-sph').value || '0'} C:${document.getElementById('re-cyl').value || '0'} A:${document.getElementById('re-axis').value || '0'} Add:${document.getElementById('re-add').value || '0'}`;
    const lePower = `S:${document.getElementById('le-sph').value || '0'} C:${document.getElementById('le-cyl').value || '0'} A:${document.getElementById('le-axis').value || '0'} Add:${document.getElementById('le-add').value || '0'}`;

    const data = {
        type: "order",
        invoice: document.getElementById('order-invoice').value,
        name: document.getElementById('order-name').value,
        contact: document.getElementById('order-contact').value,
        rightEye: rePower,
        leftEye: lePower,
        items: document.getElementById('order-items').value,
        total: document.getElementById('order-total').value || 0,
        advance: document.getElementById('order-advance').value || 0,
        balance: document.getElementById('order-balance').value || 0,
        payment: document.getElementById('order-payment').value,
        status: document.getElementById('order-status').value,
        branch: sessionUser.activeBranch // Crucial for filtering
    };

    if(!data.name || !data.invoice) return alert("Fill Name and Invoice");

    btn.disabled = true;
    btn.innerText = "Syncing with Cloud...";

    try {
        await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
        alert("Saved to " + sessionUser.activeBranch);
        location.reload();
    } catch(e) {
        alert("Error!");
        btn.disabled = false;
        btn.innerText = "Save Record";
    }
}

        async function createNewStaff() {
            const data = {
                type: "staff",
                name: document.getElementById('new-name').value,
                id: document.getElementById('new-id').value,
                pass: document.getElementById('new-pass').value,
                branch: document.getElementById('new-branch').value,
                role: "Cashier"
            };
            await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            alert("Staff Added"); location.reload();
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.getElementById(id + '-section').style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function logout(e) { 
            if(confirm("Logout?")) { sessionStorage.removeItem('alfareeda_user'); location.reload(); }
        }


        window.onload = async () => {
            const saved = sessionStorage.getItem('alfareeda_user');
            if(saved) applyUI(JSON.parse(saved));
            await loadStaff();
        };

async function loadBranchStats(userRole, myBranch) {
    try {
        const res = await fetch(scriptURL + "?type=records");
        const allRecords = await res.json();
        const dashContainer = document.getElementById('dash-section');

        // CASE 1: MANAGER VIEW (Show all branches)
        if (userRole === "Manager") {
            const branches = ["Sumail", "Izki", "Sinaw"];
            let htmlContent = `<h3 style="margin-bottom:20px; color:var(--accent);">All Branches Overview</h3>
                               <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">`;

            branches.forEach(b => {
                const branchData = allRecords.filter(r => r[12] === b);
                let total = 0, bal = 0;
                branchData.forEach(row => {
                    total += parseFloat(row[7]) || 0;
                    bal += parseFloat(row[9]) || 0;
                });

                htmlContent += `
                    <div class="data-card" style="border-top: 5px solid var(--accent);">
                        <h4 style="color:var(--primary);">${b} Branch</h4>
                        <hr style="margin:10px 0; opacity:0.1;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-size:0.8rem; color:#64748b;">Total Sales:</span>
                            <span style="font-weight:700;">${total.toFixed(3)} OMR</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-size:0.8rem; color:#64748b;">Pending Bal:</span>
                            <span style="font-weight:700; color:var(--danger);">${bal.toFixed(3)} OMR</span>
                        </div>
                    </div>`;
            });

            htmlContent += `</div>`;
            dashContainer.innerHTML = htmlContent;

        // CASE 2: CASHIER VIEW (Show only their branch)
        } else {
            const myBranchSales = allRecords.filter(r => r[12] === myBranch);
            let totalRevenue = 0, pendingBalance = 0;

            myBranchSales.forEach(row => {
                totalRevenue += parseFloat(row[7]) || 0;
                pendingBalance += parseFloat(row[9]) || 0;
            });

            dashContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="data-card" style="border-left: 5px solid var(--success);">
                        <label style="color:#64748b; font-size:0.8rem; font-weight:bold;">TOTAL SALES (${myBranch})</label>
                        <h2 style="font-size: 2rem; color: #0f172a;">${totalRevenue.toFixed(3)} OMR</h2>
                    </div>
                    <div class="data-card" style="border-left: 5px solid var(--danger);">
                        <label style="color:#64748b; font-size:0.8rem; font-weight:bold;">PENDING BALANCE</label>
                        <h2 style="font-size: 2rem; color: #f43f5e;">${pendingBalance.toFixed(3)} OMR</h2>
                    </div>
                </div>`;
        }
    } catch (e) {
        console.log("Stats error:", e);
    }
}

    </script>
</body>
</html>
