<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alfareeda Opticals | Pro POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --success: #10b981; --danger: #f43f5e; --bg: #f8fafc; --sidebar-w: 260px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #1e293b; display: flex; min-height: 100vh; }

        /* --- UI COMPONENTS --- */
        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-card { background: white; padding: 2.5rem; border-radius: 20px; width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        .sidebar { width: var(--sidebar-w); background: var(--primary); color: white; position: fixed; height: 100vh; padding: 2rem 1rem; display: none; flex-direction: column; }
        .main-content { margin-left: var(--sidebar-w); padding: 2.5rem; width: 100%; display: none; }
        .data-card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        
        /* --- FORMS --- */
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #64748b; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; font-family: inherit; }
        input:focus { outline: 2px solid var(--accent); border-color: transparent; }
        .btn-primary { background: var(--accent); color: white; border: none; width: 100%; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; }

        /* --- NAVIGATION --- */
        .nav-item { display: flex; align-items: center; gap: 12px; color: #94a3b8; padding: 12px 16px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; text-decoration: none; }
        .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--accent); }

        /* --- TABLES --- */
        .rx-table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .rx-table th { background: #f1f5f9; padding: 10px; font-size: 0.75rem; color: #64748b; }
        .rx-table td { background: white; padding: 5px; border: 1px solid #f1f5f9; }
        .rx-table input { border: none; text-align: center; padding: 8px; }


/* --- 1. HIDE FROM DASHBOARD SCREEN --- */
#print-section {
    display: none !important; /* Forces it to stay hidden on screen */
}

/* --- 2. SHOW ONLY FOR PRINTER --- */
@media print {
    /* Hide everything on the website UI */
    body * {
        visibility: hidden !important;
    }

    /* Show only the invoice section */
    #print-section, #print-section * {
        visibility: visible !important;
        display: block !important;
    }

    #print-section {
        position: absolute !important;
        left: 0 !important;
        top: 0 !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    /* Keep the Prescription table looking like a table */
    .medical-table {
        display: table !important;
        width: 100% !important;
    }
    .medical-table tr { display: table-row !important; }
    .medical-table td, .medical-table th { display: table-cell !important; }
}

/* Professional Clinical Prescription Table */
.medical-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0px;
    table-layout: fixed; /* Ensures all columns are equal width */
}

.medical-table th {
    background-color: #f1f5f9; /* Soft Professional Grey */
    border: 1px solid #1a365d; /* Sharp Navy Border */
    padding: 10px 5px;
    font-size: 11px;
    color: #1a365d;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.medical-table td {
    border: 1px solid #1a365d;
    padding: 15px 5px;
    text-align: center;
    font-size: 18px;
    font-weight: 700; /* Bold numbers for clinical clarity */
    color: #1e293b;
}

.side-label {
    background-color: #f8fafc;
    width: 30%;
    text-align: left !important;
    padding-left: 15px !important;
    font-size: 13px !important;
    color: #1a365d !important;
}

.rx-header-main {
    background-color: #1a365d;
    color: white;
    text-align: center;
    padding: 10px;
    font-weight: bold;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 2px;
    border: 1px solid #1a365d;
}


       </style>
</head>
<body>

    <div id="login-overlay" class="login-screen">
        <div class="login-card">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--accent);">ALFAREEDA LOGIN</h2>
            <div class="form-group"><label>Branch</label>
                <select id="login-branch"><option>Sumail</option><option>Izki</option><option>Sinaw</option></select>
            </div>
            <div class="form-group"><label>Staff ID</label><input type="text" id="username"></div>
            <div class="form-group"><label>Password</label><input type="password" id="password"></div>
            <button class="btn-primary" id="login-btn" onclick="handleLogin()">Login to Cloud</button>
        </div>
    </div>

    <aside id="sidebar" class="sidebar">
        <div style="font-size: 1.5rem; font-weight: 800; color: var(--accent); margin-bottom: 2rem;"><i class="fas fa-glasses"></i> ALFAREEDA</div>
        <nav style="flex-grow: 1;">
            <div class="nav-item active" onclick="showSection('dash')"><i class="fas fa-th-large"></i> Dashboard</div>
            <div class="nav-item" onclick="showSection('order')"><i class="fas fa-plus-circle"></i> New Order</div>
            <div class="nav-item" onclick="showSection('order-list'); loadOrderList();">
    <i class="fas fa-list-ul"></i> <span>Order List</span></div>
<div class="nav-item" onclick="showSection('expense')">
    <i class="fas fa-wallet"></i> Record Expense
</div>
<div class="nav-item" onclick="showSection('expense-list'); loadExpenseList();">
    <i class="fas fa-list-alt"></i> Expense History
</div>
 
      <div class="nav-item" id="nav-transactions" style="display:none;" onclick="showSection('transactions'); loadTransactionHistory();">
    <i class="fas fa-history"></i>
    <span>Transaction History</span>
</div>

            <div class="nav-item" id="nav-staff" style="display:none;" onclick="showSection('staff-mgr')"><i class="fas fa-user-shield"></i> Staff Management</div>
        </nav>
        <div class="nav-item" onclick="logout(event)" style="color:var(--danger); border-top:1px solid #334155; padding-top:20px;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </div>
    </aside>

    <main id="main-content" class="main-content">
        <header style="margin-bottom: 30px;">
            <h1 id="branch-display">Branch</h1>
            <p id="staff-display" style="color: #64748b;"></p>
        </header>

        <div id="dash-section" class="content-section">
            <div class="data-card">
                <h3>Welcome to Alfareeda POS</h3>
                <p style="margin-top:10px; color:#64748b;">Select "New Sale Record" to start entering customer orders.</p>
            </div>
        </div>

        <div id="order-section" class="content-section" style="display:none;">
            <div class="data-card">
                <h2><i class="fas fa-file-invoice"></i> Daily Sale Entry</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top:20px;">
                    <div class="form-group"><label>Invoice Number</label><input type="text" id="order-invoice"></div>
                    <div class="form-group"><label>Customer Name</label><input type="text" id="order-name"></div>
                    <div class="form-group"><label>Contact</label><input type="text" id="order-contact"></div>
                </div>

                <h3 style="font-size: 0.85rem; color: var(--accent); margin-top: 15px;">PRESCRIPTION DETAILS</h3>
<table class="rx-table">
    <thead>
        <tr>
            <th>EYE</th>
            <th>SPH</th>
            <th>CYL</th>
            <th>AXIS</th>
            <th>ADD</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Right Eye (RE)</td>
            <td><input type="text" id="re-sph" placeholder="0.00"></td>
            <td><input type="text" id="re-cyl" placeholder="0.00"></td>
            <td><input type="text" id="re-axis" placeholder="0"></td>
            <td><input type="text" id="re-add" placeholder="0.00"></td>
        </tr>
        <tr>
            <td>Left Eye (LE)</td>
            <td><input type="text" id="le-sph" placeholder="0.00"></td>
            <td><input type="text" id="le-cyl" placeholder="0.00"></td>
            <td><input type="text" id="le-axis" placeholder="0"></td>
            <td><input type="text" id="le-add" placeholder="0.00"></td>
        </tr>
    </tbody>
</table>
                <div class="form-group"><label>Items (Frame & Lens details)</label><input type="text" id="order-items"></div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group"><label>Total</label><input type="number" id="order-total" step="0.001" oninput="calcBalance()"></div>
                    <div class="form-group"><label>Advance</label><input type="number" id="order-advance" step="0.001" oninput="calcBalance()"></div>
                    <div class="form-group"><label>Balance</label><input type="number" id="order-balance" readonly style="background:#f1f5f9;"></div>
                    <div class="form-group"><label>Payment</label>
                        <select id="order-payment"><option>Cash</option><option>Bank Transfer</option><option>Card</option></select>
                    </div>
                </div>

                <div class="form-group"><label>Status</label>
                    <select id="order-status"><option>Processing</option><option>Ready</option><option>Delivered</option></select>
                </div>

                <button class="btn-primary" id="save-btn" onclick="saveOrderToCloud()">Save Order</button>
            </div>
        </div>

<div id="expense-section" class="content-section" style="display:none;">
    <div class="data-card">
        <h2><i class="fas fa-receipt"></i> Daily Expense Entry</h2>
        <p style="color: #64748b; margin-bottom: 20px;">Record any shop-related costs below.</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Category</label>
                <select id="exp-category">
                    <option>Tea & Coffee</option>
                    <option>Cleaning / Maintenance</option>
                    <option>Stationery</option>
                    <option>Electricity / Water</option>
                    <option>Stock Purchase</option>
                    <option>Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Amount (OMR)</label>
                <input type="number" id="exp-amount" step="0.001" placeholder="0.000">
            </div>
        </div>

        <div class="form-group">
            <label>Description / Remarks</label>
            <textarea id="exp-desc" rows="3" placeholder="Enter details..."></textarea>
        </div>

        <button class="btn-primary" id="exp-save-btn" onclick="saveExpense()">
            <i class="fas fa-save"></i> Save Expense
        </button>
    </div>
</div>

<div id="expense-list-section" class="content-section" style="display:none;">
    <div class="data-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2><i class="fas fa-history"></i> Expense History</h2>
            <div id="expense-total-badge" style="background:var(--danger); color:white; padding:8px 15px; border-radius:8px; font-weight:bold;">
                Total: 0.000 OMR
            </div>
        </div>
        
<div class="data-card" style="margin-bottom: 15px; background: #f8fafc; padding: 15px;">
    <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
        <div class="form-group" style="margin:0;">
            <label style="font-size: 0.75rem;">Start Date</label>
            <input type="date" id="exp-start-date" style="padding: 5px;">
        </div>
        <div class="form-group" style="margin:0;">
            <label style="font-size: 0.75rem;">End Date</label>
            <input type="date" id="exp-end-date" style="padding: 5px;">
        </div>
        <button class="btn-primary" onclick="loadExpenseList(true)" style="padding: 8px 15px; font-size: 0.8rem;">Filter</button>
        <button class="btn-secondary" onclick="resetExpFilter()" style="padding: 8px 15px; font-size: 0.8rem;">Reset</button>
    </div>
</div>

        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                    <tr style="background: #f1f5f9; text-align: left;">
                        <th style="padding: 12px;">Date</th>
                        <th style="padding: 12px;">Category</th>
                        <th style="padding: 12px;">Description</th>
                        <th style="padding: 12px;">Amount</th>
                        <th id="exp-branch-header" style="padding: 12px; display:none;">Branch</th>
                    </tr>
                </thead>
                <tbody id="expense-list-table"></tbody>
            </table>
        </div>
    </div>
</div>


        <div id="staff-mgr-section" class="content-section" style="display:none;">
            <div class="data-card">
                <h3>Add New Staff Member</h3><br>
                <div class="form-group"><label>Full Name</label><input type="text" id="new-name"></div>
                <div class="form-group"><label>Username</label><input type="text" id="new-id"></div>
                <div class="form-group"><label>Password</label><input type="password" id="new-pass"></div>
                <div class="form-group"><label>Branch</label>
                    <select id="new-branch"><option>Sumail</option><option>Izki</option><option>Sinaw</option></select>
                </div>
                <button class="btn-primary" onclick="createNewStaff()">Create Cloud Account</button>
            </div>
        </div>

<div id="transactions-section" class="content-section" style="display:none;">
    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="color: var(--primary); margin: 0;">Daily Cash Collections</h2>
            <p style="color: #64748b; font-size: 0.85rem;">Tracking all advances and balance clearances</p>
        </div>
        <div id="trans-total-badge" style="background: var(--accent); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 800; font-size: 1.1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
            Total: 0.000 OMR
        </div>
    </div>

    <div class="filter-bar" style="background: #f8fafc; padding: 15px; border-radius: 12px; display: flex; gap: 10px; align-items: flex-end; margin-bottom: 20px; border: 1px solid #e2e8f0;">
        <div style="flex: 1;">
            <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 5px; font-weight: bold;">START DATE</label>
            <input type="date" id="trans-start-date" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1;">
        </div>
        <div style="flex: 1;">
            <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 5px; font-weight: bold;">END DATE</label>
            <input type="date" id="trans-end-date" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1;">
        </div>
        <button onclick="loadTransactionHistory(true)" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
            <i class="fas fa-filter"></i> Filter
        </button>
        <button onclick="loadTransactionHistory(false)" style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
            Reset
        </button>
    </div>

    <div class="table-container" style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden;">
        <table class="data-table" style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead style="background: #f1f5f9;">
                <tr>
                    <th style="padding: 15px; color: #475569; font-size: 0.85rem;">DATE</th>
                    <th style="padding: 15px; color: #475569; font-size: 0.85rem;">INVOICE</th>
                    <th style="padding: 15px; color: #475569; font-size: 0.85rem;">CUSTOMER</th>
                    <th style="padding: 15px; color: #475569; font-size: 0.85rem;">BRANCH</th>
                    <th style="padding: 15px; color: #475569; font-size: 0.85rem;">TYPE</th>
                    <th style="padding: 15px; color: #475569; font-size: 0.85rem; text-align: right;">AMOUNT</th>
                </tr>
            </thead>
            <tbody id="transaction-list-table">
                </tbody>
        </table>
    </div>
</div>

<div id="order-list-section" class="content-section" style="display:none;">
    <div class="data-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2><i class="fas fa-history"></i> Recent Orders</h2>
            <input type="text" 
       id="search-box" 
       oninput="searchOrders()" 
       placeholder="Search Name, Mobile or Invoice..." 
       style="width: 250px; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
        </div>
        
<div class="data-card" style="margin-bottom: 15px; background: #f8fafc; padding: 15px;">
    <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
        <div class="form-group" style="margin:0;">
            <label style="font-size: 0.75rem;">Start Date</label>
            <input type="date" id="order-start-date" style="padding: 5px;">
        </div>
        <div class="form-group" style="margin:0;">
            <label style="font-size: 0.75rem;">End Date</label>
            <input type="date" id="order-end-date" style="padding: 5px;">
        </div>
        <button class="btn-primary" onclick="loadOrderList(true)" style="padding: 8px 15px; font-size: 0.8rem;">Filter</button>
        <button class="btn-secondary" onclick="resetOrderFilter()" style="padding: 8px 15px; font-size: 0.8rem;">Reset</button>
    </div>
</div>

        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
    <tr style="background: #f1f5f9; text-align: left;">
        <th style="padding: 12px;">Date</th>
        <th style="padding: 12px;">Invoice</th>
        <th style="padding: 12px;">Name</th>
        <th style="padding: 12px;">Number</th>
        <th style="padding: 12px;">Total</th>
        <th style="padding: 12px;">Balance</th>
        <th style="padding: 12px;">Status</th>
        <th id="branch-header" style="padding: 12px; display: none;">Branch</th>
        <th style="padding: 12px; text-align:right;">Actions</th>
    </tr>
</thead>
<tbody id="order-list-table"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="main-content" id="main-dashboard-area">
    <div id="print-section">
        <div class="medical-container">
            </div>
    </div>
</div>
    </main>
</main>

<div id="edit-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center;">
    <div class="data-card" style="width:350px; background:white; padding:20px; border-radius:15px;">
        <h3 style="margin-bottom:15px;">Update Order</h3>
        
        <div class="form-group">
            <label>Invoice Number</label>
            <input type="text" id="up-invoice" readonly style="background:#f1f5f9; cursor:not-allowed;">
        </div>

        <div class="form-group" style="margin-top:10px;">
            <label>Order Status</label>
            <select id="up-status">
                <option value="Pending">Pending</option>
                <option value="Ready">Ready</option>
                <option value="Delivered">Delivered</option>
            </select>
        </div>

        <div class="form-group" style="margin-top:10px;">
            <label>Remaining Balance (OMR)</label>
            <input type="number" id="up-balance" step="0.001">
        </div>

        <div style="margin-top:20px;">
            <button class="btn-primary" onclick="submitUpdate()">Save Changes</button>
            <button onclick="closeModals()" style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer; color:#64748b;">Cancel</button>
        </div>
    </div>
</div>

<div id="rx-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10001; align-items:center; justify-content:center;">
    <div class="data-card" style="width:400px; background:white; padding:25px; border-radius:15px;">
        <div id="rx-body"></div>
        <button class="btn-primary" style="margin-top:20px;" onclick="closeModals()">Close</button>
    </div>
</div>


<div id="print-section">
    <div class="medical-container">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #eee; padding-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <img src="logo.jpg.jpg" style="width: 120px; height: auto;" alt="Logo">
                <div>
                    <h2 style="margin:0; color: #1a365d;">Al Fareeda Optics</h2>
                    <div id="p-branch-address" style="font-size: 14px; color: #4a5568;">Izki Branch</div>
                </div>
            </div>
            <div style="text-align: right;">
                <h1 style="margin:0; font-size: 24px; color: #1a365d;">PRESCRIPTION INVOICE</h1>
                <div style="font-size: 18px; font-weight: bold; margin-top: 5px;">NO: <span id="p-inv-no">#</span></div>
                <div id="p-date" style="font-size: 14px; color: #718096;">Date: --/--/----</div>
            </div>
        </div>

        <div style="margin: 20px 0; display: flex; gap: 50px;">
            <div>
                <span style="font-size: 11px; color: #718096; text-transform: uppercase; font-weight: bold;">Patient Name</span>
                <div id="p-cust-name" style="font-size: 18px; font-weight: bold; color: #2d3748;">-</div>
            </div>
            <div>
                <span style="font-size: 11px; color: #718096; text-transform: uppercase; font-weight: bold;">Contact Number</span>
                <div id="p-cust-phone" style="font-size: 16px; color: #2d3748;">-</div>
            </div>
        </div>

       <div class="rx-header-main">Optical Prescription (Rx)</div>
<table class="medical-table">
    <thead>
        <tr>
            <th>EYE</th>
            <th>SPH</th>
            <th>CYL</th>
            <th>AXIS</th>
            <th>ADD</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td class="side-label"><strong>Right Eye (OD)</strong></td>
            <td id="p-re-sph">0.00</td>
            <td id="p-re-cyl">0.00</td>
            <td id="p-re-axis">0</td>
            <td id="p-re-add">0.00</td>
        </tr>
        <tr>
            <td class="side-label"><strong>Left Eye (OS)</strong></td>
            <td id="p-le-sph">0.00</td>
            <td id="p-le-cyl">0.00</td>
            <td id="p-le-axis">0</td>
            <td id="p-le-add">0.00</td>
        </tr>
    </tbody>
</table>
        <div style="margin-top: 25px;">
            <span style="font-size: 11px; color: #718096; text-transform: uppercase; font-weight: bold;">Dispensed Items / Description</span>
            <div id="p-items" style="border: 1px solid #e2e8f0; padding: 15px; margin-top: 5px; font-size: 15px; background: #fff;">-</div>
        </div>

        <div class="financial-summary-medical" style="display: flex; justify-content: flex-end;">
            <div style="width: 250px;">
                <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                    <span>Sub-Total:</span>
                    <span id="p-total">0.000</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 5px 0; color: #38a169;">
                    <span>Deposit Paid:</span>
                    <span id="p-advance">0.000</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px 0; font-size: 1.2rem; font-weight: bold; border-top: 1px solid #1a365d; color: #e53e3e;">
                    <span>Balance Due:</span>
                    <span><span id="p-balance">0.000</span> OMR</span>
                </div>
            </div>
        </div>

        <div style="margin-top: 50px; display: flex; justify-content: space-between;">
            <div style="text-align: center; width: 200px;">
                <div style="border-top: 1px solid #1a365d; margin-top: 40px; padding-top: 5px; font-size: 12px;">Customer Signature</div>
            </div>
            <div style="text-align: center; width: 200px;">
                <div style="border-top: 1px solid #1a365d; margin-top: 40px; padding-top: 5px; font-size: 12px;">Optometrist Stamp</div>
            </div>
        </div>

        <div style="margin-top: 40px; font-size: 10px; color: #718096; text-align: center; border-top: 1px dashed #cbd5e1; padding-top: 10px;">
            * This is a computer-generated prescription. Valid for 6 months from the date of issue. *
        </div>
    </div>
</div>    

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxutx2Sgsgnty1lBV13BaegnClnmvcHyRZ-rQQrJVXwWK3SmlpIo4woUvN4FA5BKsIQqA/exec'; // <--- PUT YOUR URL HERE
        let staffList = [];
        let currentOrders = [];
        let logoutTimer;

        // --- SECURITY & SESSION ---
        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            if (sessionStorage.getItem('alfareeda_user')) {
                logoutTimer = setTimeout(() => { alert("Session Expired (30 mins)"); logout(); }, 30 * 60 * 1000);
            }
        }
        ['mousedown', 'mousemove', 'keypress'].forEach(e => document.addEventListener(e, resetLogoutTimer));

        async function loadStaff() {
            try {
                const res = await fetch(scriptURL + "?type=staff");
                const data = await res.json();
                staffList = data.map(r => ({ name:r[0], id:r[1], pass:r[2], branch:r[3], role:r[4] }));
                staffList.push({ id:"admin", pass:"alf123", role:"Manager", branch:"All", name:"Master Admin" });
            } catch(e) { staffList = [{ id:"admin", pass:"alf123", role:"Manager", branch:"All" }]; }
        }

        async function handleLogin() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            const branch = document.getElementById('login-branch').value;
            const btn = document.getElementById('login-btn');
            
            btn.disabled = true; btn.innerText = "Connecting...";
            await loadStaff();

            const auth = staffList.find(s => s.id == user && s.pass == pass);
            if (auth && (auth.role === "Manager" || auth.branch === branch)) {
                const sessionData = { ...auth, activeBranch: branch };
                sessionStorage.setItem('alfareeda_user', JSON.stringify(sessionData));
                applyUI(sessionData);
            } else {
                alert("Login Failed");
                btn.disabled = false; btn.innerText = "Login to Cloud";
            }
        }

function applyUI(auth) {
    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('sidebar').style.display = 'flex';
    document.getElementById('main-content').style.display = 'block';
    document.getElementById('branch-display').innerText = auth.activeBranch + " Records";
    document.getElementById('staff-display').innerText = "Logged in as: " + (auth.name || auth.id);

    // --- ROLE BASED SIDEBAR RESTRICTIONS ---
    if(auth.role === "Manager") {
        document.getElementById('nav-staff').style.display = 'flex';         // Show Staff Management
        document.getElementById('nav-transactions').style.display = 'flex';  // Show Transaction History
    } else {
        document.getElementById('nav-staff').style.display = 'none';
        document.getElementById('nav-transactions').style.display = 'none';
    }
    
    loadBranchStats(auth.role, auth.activeBranch); 
    resetLogoutTimer();
}

        // --- BUSINESS LOGIC ---
        function calcBalance() {
            const t = parseFloat(document.getElementById('order-total').value) || 0;
            const a = parseFloat(document.getElementById('order-advance').value) || 0;
            document.getElementById('order-balance').value = (t - a).toFixed(3);
        }

        async function saveOrderToCloud() {
    const btn = document.getElementById('save-btn');
    const sessionUser = JSON.parse(sessionStorage.getItem('alfareeda_user'));

    if (!sessionUser) return alert("Please log in again.");

    const rePower = `S:${document.getElementById('re-sph').value || '0'} C:${document.getElementById('re-cyl').value || '0'} A:${document.getElementById('re-axis').value || '0'} Add:${document.getElementById('re-add').value || '0'}`;
    const lePower = `S:${document.getElementById('le-sph').value || '0'} C:${document.getElementById('le-cyl').value || '0'} A:${document.getElementById('le-axis').value || '0'} Add:${document.getElementById('le-add').value || '0'}`;

    const data = {
        type: "order",
        invoice: document.getElementById('order-invoice').value,
        name: document.getElementById('order-name').value,
        contact: document.getElementById('order-contact').value,
        rightEye: rePower,
        leftEye: lePower,
        items: document.getElementById('order-items').value,
        total: document.getElementById('order-total').value || 0,
        advance: document.getElementById('order-advance').value || 0,
        balance: document.getElementById('order-balance').value || 0,
        payment: document.getElementById('order-payment').value,
        status: document.getElementById('order-status').value,
        branch: sessionUser.activeBranch // Crucial for filtering
    };

    if(!data.name || !data.invoice) return alert("Fill Name and Invoice");

    btn.disabled = true;
    btn.innerText = "Syncing with Cloud...";

    try {
        await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
        alert("Saved to " + sessionUser.activeBranch);
        location.reload();
    } catch(e) {
        alert("Error!");
        btn.disabled = false;
        btn.innerText = "Save Record";
    }
}

        async function createNewStaff() {
            const data = {
                type: "staff",
                name: document.getElementById('new-name').value,
                id: document.getElementById('new-id').value,
                pass: document.getElementById('new-pass').value,
                branch: document.getElementById('new-branch').value,
                role: "Cashier"
            };
            await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            alert("Staff Added"); location.reload();
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.getElementById(id + '-section').style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function logout(e) { 
            if(confirm("Logout?")) { sessionStorage.removeItem('alfareeda_user'); location.reload(); }
        }

        async function loadOrderList(isFiltered = false) {
    const tableBody = document.getElementById('order-list-table');
    const user = JSON.parse(sessionStorage.getItem('alfareeda_user'));
    if (!user) return;

    const isAdmin = user.role === "Manager";
    const branchHeader = document.getElementById('branch-header');
    
    // Toggle header visibility
    if (branchHeader) {
        branchHeader.style.display = isAdmin ? "table-cell" : "none";
    }

    // 1. Date Filtering Logic
    let startDate = null;
    let endDate = null;
    if (isFiltered) {
        const startVal = document.getElementById('order-start-date').value;
        const endVal = document.getElementById('order-end-date').value;
        if (!startVal || !endVal) {
            alert("Please select both Start and End dates");
            return;
        }
        startDate = new Date(startVal);
        startDate.setHours(0, 0, 0, 0);
        endDate = new Date(endVal);
        endDate.setHours(23, 59, 59, 999);
    }

    tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:20px;">Fetching Cloud Records...</td></tr>`;

    try {
        const res = await fetch(scriptURL + "?type=Records"); 
        const allRecords = await res.json();
        currentOrders = allRecords; // This saves the data so the print function can find it
        
        const displayRecords = allRecords.filter(r => {
            const rowDate = new Date(r[0]);
            const branchMatch = isAdmin ? true : r[12] === user.activeBranch;
            
            if (isFiltered) {
                return branchMatch && rowDate >= startDate && rowDate <= endDate;
            }
            return branchMatch;
        });

        displayRecords.reverse(); 

        tableBody.innerHTML = '';
        if (displayRecords.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:20px;">No records found for this period.</td></tr>`;
            return;
        }

        displayRecords.forEach(row => {
            const dateStr = new Date(row[0]).toLocaleDateString('en-GB');
            const inv = row[1];
            const name = row[2];
            const phone = row[3];
            
            // --- NEW: Extract Total Amount and Balance ---
            const totalAmt = parseFloat(row[7]) || 0; 
            const balance = parseFloat(row[9]) || 0;
            
            const status = row[11];
            const branchName = row[12] || 'N/A';
            
            const rxData = JSON.stringify({
                name: name, invoice: inv, re: row[4], le: row[5], items: row[6]
            }).replace(/"/g, '&quot;');

            let badgeColor = status === 'Delivered' ? '#10b981' : (status === 'Ready' ? '#3b82f6' : '#f59e0b');
            let branchTd = isAdmin ? `<td style="padding: 12px; color:#64748b;">${branchName}</td>` : '';

            tableBody.innerHTML += `
            <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 12px;">${dateStr}</td>
                <td style="padding: 12px; font-weight:600;">${inv}</td>
                <td style="padding: 12px;">${name}</td>
                <td style="padding: 12px; color:#64748b;">${phone}</td>
                
                <td style="padding: 12px; font-weight:bold; color:#1e293b;">
                    ${totalAmt.toFixed(3)}
                </td>

                <td style="padding: 12px; font-weight:bold; color:${balance > 0 ? '#f43f5e' : '#10b981'};">
                    ${balance.toFixed(3)}
                </td>
                <td style="padding: 12px;">
                    <span style="background:${badgeColor}22; color:${badgeColor}; padding:4px 10px; border-radius:12px; font-size:0.75rem; font-weight:bold;">
                        ${status}
                    </span>
                </td>
                ${branchTd}
                <td style="padding: 12px; text-align:right; display:flex; gap:8px; justify-content:flex-end;">
                    <button onclick="showRx('${rxData}')" style="background:#f1f5f9; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;" title="View Rx">
                        <i class="fas fa-eye"></i>
                    </button>

                    <button onclick="printOrder('${inv}')" style="background:#0ea5e9; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;" title="Print Invoice">
                        <i class="fas fa-print"></i>
                    </button>

                    <button onclick="openEditModal('${inv}', '${balance}', '${status}')" style="background:var(--accent); color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;" title="Edit Status">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>`;
        });
    } catch (e) {
        console.error(e);
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:red;">Connection Error</td></tr>';
    }
}        window.onload = async () => {
            const saved = sessionStorage.getItem('alfareeda_user');
            if(saved) applyUI(JSON.parse(saved));
            await loadStaff();
        };

async function loadBranchStats(userRole, myBranch) {
    const dashContainer = document.getElementById('dash-section');
    dashContainer.innerHTML = '<div style="text-align:center; padding:50px;"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Calculating Financials...</p></div>';

    try {
        const [salesRes, expRes] = await Promise.all([
            fetch(scriptURL + "?type=Records"),
            fetch(scriptURL + "?type=Expenses")
        ]);
        
        const allSales = await salesRes.json();
        const allExpenses = await expRes.json();

        if (userRole === "Manager") {
            renderManagerDash(allSales, allExpenses);
        } else {
            renderCashierDash(allSales, allExpenses, myBranch);
        }
    } catch (e) {
        dashContainer.innerHTML = '<p style="color:red;">Error loading dashboard data.</p>';
    }
}

// Helper to check if a date is "Today"
function isToday(dateString) {
    const today = new Date();
    const target = new Date(dateString);
    return today.getDate() === target.getDate() &&
           today.getMonth() === target.getMonth() &&
           today.getFullYear() === target.getFullYear();
}

function isThisMonth(dateString) {
    const now = new Date();
    const target = new Date(dateString);
    return now.getMonth() === target.getMonth() &&
           now.getFullYear() === target.getFullYear();
}

function renderCashierDash(allSales, allExpenses, branch) {
    const bSales = allSales.filter(r => r[12] === branch);
    const bExp = allExpenses.filter(e => e[4] === branch);
    
    // Today's Calculations (Stays the same)
    const todaySales = bSales.filter(r => isToday(r[0]));
    const todayExp = bExp.filter(e => isToday(e[0]));
    
    let tSalesVal = todaySales.reduce((s, r) => s + (parseFloat(r[7]) || 0), 0);
    let tExpVal = todayExp.reduce((s, e) => s + (parseFloat(e[2]) || 0), 0);
    

    // --- UPDATED: Monthly Calculations (Formerly Overall) ---
    const monthlySales = bSales.filter(r => isThisMonth(r[0]));
    const monthlyExp = bExp.filter(e => isThisMonth(e[0]));

    let totalRev = monthlySales.reduce((s, r) => s + (parseFloat(r[7]) || 0), 0);
    let totalExp = monthlyExp.reduce((s, e) => s + (parseFloat(e[2]) || 0), 0);
    
    // Note: Pending usually stays "All Time" so you don't lose track of old debt
    let pending = bSales.reduce((s, r) => s + (parseFloat(r[9]) || 0), 0);

    document.getElementById('dash-section').innerHTML = `
        <h3 style="margin-bottom:15px; color:var(--primary); font-size:1rem; opacity:0.8;">TODAY'S SNAPSHOT</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom:30px;">
            <div class="data-card" style="background:var(--primary); color:white; padding:1.5rem;">
                <small>TODAY'S SALES</small>
                <h2 style="margin:5px 0;">${tSalesVal.toFixed(3)}</h2>
            </div>
            <div class="data-card" style="border: 1px solid #e2e8f0; padding:1.5rem;">
                <small style="color:#64748b;">TODAY'S EXPENSE</small>
                <h2 style="margin:5px 0; color:var(--danger);">${tExpVal.toFixed(3)}</h2>
            </div>
            
        </div>

        <h3 style="margin-bottom:15px; color:var(--primary); font-size:1rem; opacity:0.8;">PERFORMANCE THIS MONTH (${branch})</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;">
            <div class="data-card">
                <small style="color:#64748b;">MONTHLY REVENUE</small>
                <h3>${totalRev.toFixed(3)} OMR</h3>
            </div>
            <div class="data-card">
                <small style="color:#64748b;">MONTHLY EXPENSES</small>
                <h3>${totalExp.toFixed(3)} OMR</h3>
            </div>
            <div class="data-card" style="background: #fff1f2; border: 1px solid #fecdd3;">
                <small style="color:#9f1239;">TOTAL PENDING BALANCES</small>
                <h3 style="color:#9f1239;">${pending.toFixed(3)} OMR</h3>
            </div>
        </div>
    `;
}

function renderManagerDash(allSales, allExpenses) {
    const branches = ["Sumail", "Izki", "Sinaw"];
    let html = `<h2>Branch Performance (This Month)</h2>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:25px;">`;

    branches.forEach(b => {
        const bSales = allSales.filter(r => r[12] === b);
        const bExp = allExpenses.filter(e => e[4] === b);
        
        const tSalesVal = bSales.filter(r => isToday(r[0])).reduce((s, r) => s + (parseFloat(r[7]) || 0), 0);
        const tExpVal = bExp.filter(e => isToday(e[0])).reduce((s, e) => s + (parseFloat(e[2]) || 0), 0);

        // --- UPDATED: Filtering for current month only ---
        let totalRev = bSales.filter(r => isThisMonth(r[0])).reduce((s, r) => s + (parseFloat(r[7]) || 0), 0);
        let totalExp = bExp.filter(e => isThisMonth(e[0])).reduce((s, e) => s + (parseFloat(e[2]) || 0), 0);

        html += `
            <div class="data-card" style="padding:0; overflow:hidden;">
                <div style="background:var(--primary); color:white; padding:1.2rem;">
                    <h3 style="margin:0;">${b} Branch</h3>
                </div>
                <div style="padding:1.5rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; padding-bottom:10px; border-bottom:1px dashed #eee;">
                        <span><strong>Today's Net:</strong></span>
                        <span style="color:${(tSalesVal - tExpVal) >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight:bold;">
                            ${(tSalesVal - tExpVal).toFixed(3)} OMR
                        </span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:8px;">
                        <span style="color:#64748b;">Month Revenue:</span>
                        <span>${totalRev.toFixed(3)}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:8px;">
                        <span style="color:#64748b;">Month Expenses:</span>
                        <span style="color:var(--danger);">${totalExp.toFixed(3)}</span>
                    </div>
                    <div style="margin-top:15px; background:#f0f9ff; padding:10px; border-radius:8px; text-align:center;">
                        <small style="color:#0369a1; font-weight:bold;">MONTHLY NET PROFIT</small>
                        <div style="font-size:1.2rem; font-weight:800; color:var(--accent);">${(totalRev - totalExp).toFixed(3)} OMR</div>
                    </div>
                </div>
            </div>`;
    });

    html += `</div>`;
    document.getElementById('dash-section').innerHTML = html;
}

// This function opens the Edit window when the pencil icon is clicked
function openEditModal(inv, bal, stat) {
    const modal = document.getElementById('edit-modal');
    const invField = document.getElementById('up-invoice');
    const balField = document.getElementById('up-balance');
    const statField = document.getElementById('up-status');

    if (modal && invField && balField && statField) {
        invField.value = inv;
        balField.value = bal;
        statField.value = stat;
        modal.style.display = 'flex';
    } else {
        console.error("One or more Edit Modal elements are missing from HTML");
    }
}

// This function sends the updated status and balance to your Google Sheet
async function submitUpdate() {
    const inv = document.getElementById('up-invoice').value;
    const bal = document.getElementById('up-balance').value;
    const stat = document.getElementById('up-status').value;
    
    // Get session user to know which branch is collecting the money
    const sessionUser = JSON.parse(sessionStorage.getItem('alfareeda_user'));

    if (!inv) {
        alert("Error: Invoice number is missing.");
        return;
    }

    const btn = event.target;
    const originalText = btn.innerText;
    btn.innerText = "Updating Cloud...";
    btn.disabled = true;

    // FIND OLD DATA: We need the previous balance and name to calculate the payment
    const oldOrder = currentOrders.find(r => String(r[1]) === String(inv));
    const oldBalance = oldOrder ? parseFloat(oldOrder[9]) : 0;
    const customerName = oldOrder ? oldOrder[2] : "Unknown";
    
    // Calculate how much cash was actually handed over right now
    const amountPaidNow = oldBalance - parseFloat(bal);

    const data = {
        action: "update",
        invoice: inv,
        balance: bal,
        status: stat,
        // New fields for the Collection Sheet
        amountCollected: amountPaidNow > 0 ? amountPaidNow : 0, 
        branch: sessionUser ? sessionUser.activeBranch : "Unknown",
        customerName: customerName
    };

    try {
        await fetch(scriptURL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(data) 
        });

        alert("Order " + inv + " updated and cash logged!");
        closeModals();
        location.reload(); 
    } catch (e) {
        console.error("Update Error:", e);
        alert("Connection Error. Please try again.");
        btn.innerText = originalText;
        btn.disabled = false;
    }
}
// This function handles the "Prescription" button
function showRx(jsonStr) {
    const modal = document.getElementById('rx-modal');
    const body = document.getElementById('rx-body');
    
    // Parse the JSON string back into an object
    const data = JSON.parse(jsonStr);

    if (modal && body) {
        body.innerHTML = `
            <h2 style="color:var(--accent); margin-bottom:15px;">Prescription Card</h2>
            <p><strong>Customer:</strong> ${data.name}</p>
            <p><strong>Invoice:</strong> ${data.invoice}</p>
            <hr style="margin:15px 0; opacity:0.1;">
            <div style="background:#f8fafc; padding:15px; border-radius:8px; line-height:1.6;">
                <p><strong>Right Eye (RE):</strong><br> ${data.re || 'N/A'}</p>
                <p style="margin-top:10px;"><strong>Left Eye (LE):</strong><br> ${data.le || 'N/A'}</p>
            </div>
            <div style="margin-top:15px;">
                <p><strong>Lens/Items:</strong><br> ${data.items || 'None'}</p>
            </div>
        `;
        modal.style.display = 'flex';
    }
}

// Function to close any open popup
function closeModals() {
    if(document.getElementById('rx-modal')) document.getElementById('rx-modal').style.display = 'none';
    if(document.getElementById('edit-modal')) document.getElementById('edit-modal').style.display = 'none';
}

function searchOrders() {
    // 1. Get the search input
    const input = document.getElementById('search-box');
    if (!input) return;
    const filter = input.value.toLowerCase();
    
    // 2. Target YOUR specific table body ID
    const tableBody = document.getElementById('order-list-table');
    if (!tableBody) return;

    // 3. Get all rows inside that table body
    const rows = tableBody.getElementsByTagName('tr');

    // 4. Loop through the rows
    for (let i = 0; i < rows.length; i++) {
        // Get the text from Name (3rd column) and Invoice (2nd column)
        const rowText = rows[i].textContent || rows[i].innerText;
        
        if (rowText.toLowerCase().indexOf(filter) > -1) {
            rows[i].style.display = ""; // Show
        } else {
            rows[i].style.display = "none"; // Hide
        }
    }
}

async function saveExpense() {
    const sessionUser = JSON.parse(sessionStorage.getItem('alfareeda_user'));
    if (!sessionUser) {
        alert("Session expired. Please login again.");
        return;
    }

    const amount = document.getElementById('exp-amount').value;
    if (!amount) {
        alert("Please enter an amount");
        return;
    }

    const data = {
        type: "expense",
        category: document.getElementById('exp-category').value,
        amount: amount,
        description: document.getElementById('exp-desc').value,
        branch: sessionUser.activeBranch,
        staff: sessionUser.id
    };

    console.log("Sending data:", data); // This helps you see if the data is ready

    try {
        await fetch(scriptURL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(data) 
        });
        alert("Expense Sent to Cloud!");
        location.reload(); 
    } catch(e) {
        console.error("Fetch error:", e);
        alert("Network Error");
    }
}

async function loadExpenseList(isFiltered = false) {
    const tableBody = document.getElementById('expense-list-table');
    const totalBadge = document.getElementById('expense-total-badge');
    const user = JSON.parse(sessionStorage.getItem('alfareeda_user'));
    if (!user) return;

    const isAdmin = user.role === "Manager";
    const branchHeader = document.getElementById('exp-branch-header');
    if (branchHeader) {
        branchHeader.style.display = isAdmin ? "table-cell" : "none";
    }

    // 1. Get Date Values if filtering is active
    let startDate = null;
    let endDate = null;
    if (isFiltered) {
        const startVal = document.getElementById('exp-start-date').value;
        const endVal = document.getElementById('exp-end-date').value;
        if (!startVal || !endVal) {
            alert("Please select both Start and End dates");
            return;
        }
        startDate = new Date(startVal);
        startDate.setHours(0, 0, 0, 0);
        endDate = new Date(endVal);
        endDate.setHours(23, 59, 59, 999);
    }

    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Loading Expenses...</td></tr>';

    try {
        const res = await fetch(scriptURL + "?type=Expenses"); 
        const allExpenses = await res.json();
        
        // 2. Combined Filter: Branch Security + Date Range
        const displayData = allExpenses.filter(e => {
            const rowDate = new Date(e[0]);
            const branchMatch = isAdmin ? true : e[4] === user.activeBranch;
            
            if (isFiltered) {
                return branchMatch && rowDate >= startDate && rowDate <= endDate;
            }
            return branchMatch;
        });

        displayData.reverse(); // Newest first

        let html = '';
        let totalSum = 0;

        displayData.forEach(row => {
            const date = new Date(row[0]).toLocaleDateString('en-GB');
            const category = row[1];
            const amount = parseFloat(row[2]) || 0;
            const desc = row[3];
            const branch = row[4];
            
            totalSum += amount;

            html += `
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 12px;">${date}</td>
                    <td style="padding: 12px;"><span style="background:#eee; padding:3px 8px; border-radius:4px; font-size:0.8rem;">${category}</span></td>
                    <td style="padding: 12px; color:#64748b;">${desc}</td>
                    <td style="padding: 12px; font-weight:bold; color:var(--danger);">${amount.toFixed(3)}</td>
                    ${isAdmin ? `<td style="padding: 12px;">${branch}</td>` : ''}
                </tr>`;
        });

        tableBody.innerHTML = html || '<tr><td colspan="5" style="text-align:center; padding:20px;">No expenses found for this period.</td></tr>';
        
        // 3. Update the Total Badge with the filtered sum
        totalBadge.innerText = `Total: ${totalSum.toFixed(3)} OMR`;

    } catch (e) {
        console.error(e);
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Failed to load data.</td></tr>';
    }
}

function printOrder(invoiceId) {
    const order = currentOrders.find(r => String(r[1]) === String(invoiceId)); 
    if(!order) {
        alert("Order data not found.");
        return;
    }

    // 1. Map Header & Customer Data
    document.getElementById('p-inv-no').innerText = "#" + order[1]; // [cite: 9]
    document.getElementById('p-date').innerText = "Date: " + new Date(order[0]).toLocaleDateString('en-GB'); // [cite: 10]
    document.getElementById('p-branch-address').innerText = (order[12] || "Main") + " Branch"; // [cite: 2]
    document.getElementById('p-cust-name').innerText = order[2]; // [cite: 4]
    document.getElementById('p-cust-phone').innerText = "Mobile: " + order[3]; // [cite: 5]
    
    // 2. Parse and Fill Prescription (Rx) Table
    const re = parseRx(order[4]); // [cite: 11]
    const le = parseRx(order[5]); // [cite: 11]

    document.getElementById('p-re-sph').innerText = re.s;
    document.getElementById('p-re-cyl').innerText = re.c;
    document.getElementById('p-re-axis').innerText = re.a;
    document.getElementById('p-re-add').innerText = re.ad;

    document.getElementById('p-le-sph').innerText = le.s;
    document.getElementById('p-le-cyl').innerText = le.c;
    document.getElementById('p-le-axis').innerText = le.a;
    document.getElementById('p-le-add').innerText = le.ad;
    
    // 3. Fill Items & Financials
    document.getElementById('p-items').innerText = order[6] || 'N/A'; // [cite: 13]
    
    // Fixed: Direct ID access instead of querySelector('.financial-box')
    document.getElementById('p-total').innerText = parseFloat(order[7]).toFixed(3); // 
    document.getElementById('p-advance').innerText = parseFloat(order[8] || 0).toFixed(3); // 
    document.getElementById('p-balance').innerText = parseFloat(order[9]).toFixed(3); // 

    window.print();
}

// Helper function to extract SPH, CYL, AXIS, and ADD from the saved string
function parseRx(rxStr) {
    if (!rxStr || rxStr === "N/A") {
        return { s: '-', c: '-', a: '-', ad: '-' };
    }
    
    // This matches the format "S:1.25 C:1.00 A:80 Add:0" used in your records
    return {
        s: rxStr.match(/S:([^ ]+)/)?.[1] || '-',
        c: rxStr.match(/C:([^ ]+)/)?.[1] || '-',
        a: rxStr.match(/A:([^ ]+)/)?.[1] || '-',
        ad: rxStr.match(/Add:([^ ]+)/)?.[1] || '-'
    };
}


async function loadTransactionHistory(isFiltered = false) {
    const tableBody = document.getElementById('transaction-list-table');
    const totalBadge = document.getElementById('trans-total-badge');
    const user = JSON.parse(sessionStorage.getItem('alfareeda_user'));
    
    // Security check
    if (!user || user.role !== "Manager") return;

    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;"><i class="fas fa-spinner fa-spin"></i> Loading Transactions...</td></tr>';

    try {
        const res = await fetch(scriptURL + "?type=Collections");
        const allTrans = await res.json();
        
        let startDate = isFiltered ? new Date(document.getElementById('trans-start-date').value) : null;
        let endDate = isFiltered ? new Date(document.getElementById('trans-end-date').value) : null;
        if(startDate) startDate.setHours(0,0,0,0);
        if(endDate) endDate.setHours(23,59,59,999);

        // Sort: Newest at the top
        allTrans.reverse();

        let html = '';
        let totalSum = 0;

        allTrans.forEach(row => {
            const rowDate = new Date(row[0]);
            const amount = parseFloat(row[5]) || 0;

            // Date filtering logic
            if (isFiltered && startDate && endDate) {
                if (rowDate < startDate || rowDate > endDate) return;
            }

            totalSum += amount;

            html += `
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 15px; font-size: 0.9rem;">${rowDate.toLocaleDateString('en-GB')}</td>
                    <td style="padding: 15px; font-weight: bold; color: var(--primary);">#${row[1]}</td>
                    <td style="padding: 15px; color: #1e293b;">${row[2]}</td>
                    <td style="padding: 15px; color: #64748b;">${row[3]}</td>
                    <td style="padding: 15px;">
                        <span style="background:${row[4] === 'Advance' ? '#e0f2fe' : '#dcfce7'}; 
                                     color:${row[4] === 'Advance' ? '#0369a1' : '#166534'}; 
                                     padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:bold;">
                            ${row[4]}
                        </span>
                    </td>
                    <td style="padding: 15px; text-align: right; font-weight: 800; color: var(--accent);">
                        ${amount.toFixed(3)}
                    </td>
                </tr>`;
        });

        tableBody.innerHTML = html || '<tr><td colspan="6" style="text-align:center; padding:30px;">No transactions found for this period.</td></tr>';
        totalBadge.innerText = "Total: " + totalSum.toFixed(3) + " OMR";

    } catch (e) {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red; padding:30px;">Failed to load history. Check "Collections" sheet.</td></tr>';
    }
}

    </script>

</body>
</html>
