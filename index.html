<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alfareeda Opticals | Cloud POS Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --sidebar-width: 260px;
            --primary: #1e293b;
            --accent: #3b82f6;
            --bg: #f1f5f9;
            --text: #334155;
            --white: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width); height: 100vh; background: var(--primary);
            color: white; position: fixed; padding: 20px 0; display: flex; flex-direction: column;
        }
        .brand { padding: 0 25px 30px; font-size: 1.4rem; font-weight: 700; color: var(--accent); border-bottom: 1px solid #334155; margin-bottom: 20px; }
        .nav-link {
            padding: 15px 25px; display: flex; align-items: center; gap: 15px;
            color: #94a3b8; text-decoration: none; cursor: pointer; border: none; background: none;
            width: 100%; font-size: 1rem; text-align: left; transition: 0.3s;
        }
        .nav-link:hover, .nav-link.active { background: #334155; color: white; }
        .nav-link.active { border-left: 4px solid var(--accent); }

        /* --- MAIN CONTENT --- */
        .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); padding: 40px; }
        header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 25px; }
        
        /* --- DASHBOARD STATS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 20px; }
        .stat-card h3 { font-size: 0.85rem; text-transform: uppercase; color: #64748b; margin-bottom: 10px; }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; }

        /* --- FORMS & TABLES --- */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; font-family: inherit; }
        
        .btn-primary { 
            background: var(--accent); color: white; padding: 14px; border: none; 
            border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.3s;
        }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; }

        .loading-spinner { color: var(--accent); font-weight: 600; text-align: center; padding: 20px; }

        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .brand, .nav-text { display: none; }
            .main-content { margin-left: 70px; width: calc(100% - 70px); padding: 20px; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand">ALFAREEDA</div>
        <nav>
            <button class="nav-link active" onclick="showSection('dashboard', this)">
                <i class="fas fa-chart-pie"></i> <span class="nav-text">Dashboard</span>
            </button>
            <button class="nav-link" onclick="showSection('new-order', this)">
                <i class="fas fa-plus-circle"></i> <span class="nav-text">New Order</span>
            </button>
            <button class="nav-link" onclick="showSection('expenses', this)">
                <i class="fas fa-file-invoice-dollar"></i> <span class="nav-text">Expenses</span>
            </button>
            <button class="nav-link" onclick="showSection('database', this)">
                <i class="fas fa-database"></i> <span class="nav-text">Database</span>
            </button>
        </nav>
    </aside>

    <main class="main-content">
        <header>
            <h1 id="page-title">Dashboard</h1>
            <button class="btn-primary" style="width: auto; padding: 8px 15px;" onclick="fetchFromSheets()">
                <i class="fas fa-sync"></i> Sync Data
            </button>
        </header>

        <section id="dashboard" class="content-section">
            <div class="stats-grid">
                <div class="card stat-card">
                    <h3>Monthly Sales</h3>
                    <div class="value" id="dash-sales" style="color: var(--success)">OMR 0.000</div>
                </div>
                <div class="card stat-card">
                    <h3>Total Expenses</h3>
                    <div class="value" id="dash-expenses" style="color: var(--danger)">OMR 0.000</div>
                </div>
                <div class="card stat-card">
                    <h3>Profit</h3>
                    <div class="value" id="dash-profit">OMR 0.000</div>
                </div>
            </div>
        </section>

        <section id="new-order" class="content-section" style="display:none;">
            <div class="card">
                <h2>Create New Order</h2><br>
                <div class="form-grid">
                    <div class="form-group"><label>Invoice #</label><input type="text" id="order-invoice" placeholder="ALF-100"></div>
                    <div class="form-group"><label>Customer Name</label><input type="text" id="order-name"></div>
                    <div class="form-group"><label>Contact</label><input type="tel" id="order-contact"></div>
                    <div class="form-group"><label>Total (OMR)</label><input type="number" id="order-total" step="0.001"></div>
                </div>
                <div class="form-group"><label>Prescription Details</label><textarea id="order-details" rows="3"></textarea></div>
                <button class="btn-primary" id="save-btn" onclick="saveOrder()">Save to Cloud & Local</button>
            </div>
        </section>

        <section id="expenses" class="content-section" style="display:none;">
            <div class="card">
                <h2>Record Expense</h2><br>
                <div class="form-group"><label>Amount (OMR)</label><input type="number" id="exp-amount" step="0.001"></div>
                <button class="btn-primary" onclick="saveExpense()">Record Expense</button>
            </div>
        </section>

        <section id="database" class="content-section" style="display:none;">
            <div class="card">
                <input type="text" id="search" onkeyup="searchDB()" placeholder="Search records..." style="margin-bottom: 15px;">
                <div style="overflow-x: auto;">
                    <table>
                        <thead><tr><th>Invoice</th><th>Name</th><th>Contact</th><th>Total</th><th>Date</th></tr></thead>
                        <tbody id="order-list"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- CONFIGURATION ---
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyEnldRpUydacgjImyge1_xBGnM8fy1dP8rKgarPxXavZnkC02TLjOjNklJIKbjdytEqg/exec'; 
        let orders = JSON.parse(localStorage.getItem('alfareeda_orders')) || [];
        let expenses = JSON.parse(localStorage.getItem('alfareeda_expenses')) || [];

        // --- NAVIGATION ---
        function showSection(id, btn) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            document.getElementById('page-title').innerText = btn.innerText.trim();
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- SAVE DATA ---
        async function saveOrder() {
            const btn = document.getElementById('save-btn');
            const data = {
                invoice: document.getElementById('order-invoice').value,
                name: document.getElementById('order-name').value,
                contact: document.getElementById('order-contact').value,
                total: document.getElementById('order-total').value,
                details: document.getElementById('order-details').value
            };

            if(!data.name || !data.invoice) return alert("Required fields missing!");

            btn.disabled = true; btn.innerText = "Syncing with Google...";

            try {
                // 1. Send to Google Sheets
                await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });

                // 2. Save locally for instant update
                orders.push({...data, date: new Date().toLocaleDateString()});
                localStorage.setItem('alfareeda_orders', JSON.stringify(orders));
                
                alert("Saved successfully!");
                location.reload(); // Refresh to sync everything
            } catch (e) {
                alert("Cloud sync failed, but data saved locally.");
            }
        }

        function saveExpense() {
            const amt = parseFloat(document.getElementById('exp-amount').value) || 0;
            expenses.push({amount: amt});
            localStorage.setItem('alfareeda_expenses', JSON.stringify(expenses));
            updateDashboard();
            alert("Expense Saved!");
        }

        // --- FETCH & RENDER ---
        async function fetchFromSheets() {
            const list = document.getElementById('order-list');
            list.innerHTML = '<tr><td colspan="5" class="loading-spinner">Fetching from Cloud...</td></tr>';
            
            try {
                const res = await fetch(scriptURL);
                const cloudData = await res.json();
                orders = cloudData;
                localStorage.setItem('alfareeda_orders', JSON.stringify(orders));
                renderTable();
                updateDashboard();
            } catch (e) {
                renderTable(); // Fallback to local
            }
        }

        function renderTable() {
            const list = document.getElementById('order-list');
            list.innerHTML = '';
            orders.slice().reverse().forEach(o => {
                list.innerHTML += `<tr><td>${o.invoice}</td><td><strong>${o.name}</strong></td><td>${o.contact}</td><td>${parseFloat(o.total).toFixed(3)}</td><td>${new Date(o.date).toLocaleDateString()}</td></tr>`;
            });
        }

        function updateDashboard() {
            const sales = orders.reduce((s, o) => s + parseFloat(o.total || 0), 0);
            const exps = expenses.reduce((s, e) => s + parseFloat(e.amount || 0), 0);
            document.getElementById('dash-sales').innerText = `OMR ${sales.toFixed(3)}`;
            document.getElementById('dash-expenses').innerText = `OMR ${exps.toFixed(3)}`;
            document.getElementById('dash-profit').innerText = `OMR ${(sales - exps).toFixed(3)}`;
        }

        function searchDB() {
            const q = document.getElementById('search').value.toLowerCase();
            document.querySelectorAll('#order-list tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none');
        }

        // Initialize
        window.onload = () => {
            renderTable();
            updateDashboard();
        };
    </script>
</body>
</html>
